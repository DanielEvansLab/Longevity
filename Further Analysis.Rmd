---
title: "Further Analysis for Specific Exposures"
author: "Christine Le"
date: "11/8/2020"
output: html_document
---

# Setup
```{r setup, include=FALSE}


#data



Pilling_dat <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/MR/MR_pilling_filterF.rds")
Timmers_dat <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/MR/MR_timmers_F.rds")
Cases90_dat <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/MR/MR_cases_90_F.rds")
Cases99_dat <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/MR/MR_cases_99_F.rds")
```



load libraries

```{r include=FALSE}
library(TwoSampleMR)
library(MRInstruments)
library(tidyverse) #so we can use purrr::map, and no, not just because I got cats
library(knitr)
library(ieugwasr)
library(arsenal)
library(tidyverse)
library(multtest)
library(doParallel)
library(VennDiagram)
library(reactable)
library(patchwork)
library(kableExtra)
```


# Pull out MR Egger Analysis for five selected Exposures

## Combine four outcomes

```{r results='hide', include=FALSE}
#merge all four outcomes
#Create a table containing adjusted p-values and information on exposure dataset, and outcome dataset sources
PillingA <- Pilling_dat %>% 
  mutate(Pilling = "YES") %>%
  rename(Exposure.Dataset.Pilling = exposure_dat, 
         b.pilling = b, se.pilling = se, nsnp.pilling = nsnp, pval.pilling = pval ) %>% 
  select(-id.exposure, -id.outcome, -outcome ) 
TimmersA <- Timmers_dat %>% 
  mutate(Timmers = "YES") %>%
  rename(Exposure.Dataset.Timmers = exposure_dat, 
         b.timmers = b, se.timmers = se, nsnp.timmers = nsnp, pval.timmers = pval) %>% 
  select(-id.exposure, -id.outcome, -outcome ) 
Cases90A <- Cases90_dat %>%
  mutate(Cases90 = "YES") %>%
  rename(Exposure.Dataset.Cases90 = exposure_dat, 
         b.90 = b, se.90 = se, nsnp.90 = nsnp, pval.90 = pval) %>% 
  select(-id.exposure, -id.outcome, -outcome)
Cases99A <- Cases99_dat %>%
  mutate(Cases99 = "YES") %>%
  rename(Exposure.Dataset.Cases99 = exposure_dat, 
         b.99 = b, se.99 = se, nsnp.99 = nsnp, pval.99 = pval) %>% 
  select(-id.exposure, -id.outcome, -outcome)

dat_all <- PillingA %>% full_join(TimmersA, by =  c("exposure", "method"))
dat_all <- dat_all%>% full_join(Cases90A, by = c("exposure", "method"))
dat_all <- dat_all %>% full_join(Cases99A, by = c("exposure","method"))


#replace NAs in Dataset columns with "NO"

dat_all$Pilling <- ifelse(is.na(dat_all$Pilling), "NO", dat_all$Pilling)
dat_all$Timmers <- ifelse(is.na(dat_all$Timmers), "NO", dat_all$Timmers)
dat_all$Cases90 <- ifelse(is.na(dat_all$Cases90), "NO", dat_all$Cases90)
dat_all$Cases99 <- ifelse(is.na(dat_all$Cases99), "NO", dat_all$Cases99)



#Make one Exposure Dataset column

dat_all$Exposure.Dataset <- ifelse(dat_all$Pilling == "YES", dat_all$Exposure.Dataset.Pilling,
                               ifelse(dat_all$Timmers == "YES", dat_all$Exposure.Dataset.Timmers,
                                      ifelse(dat_all$Cases90 == "YES", dat_all$Exposure.Dataset.Cases90,
                                             ifelse(dat_all$Cases99 == "YES", dat_all$Exposure.Dataset.Cases99, NA)
                                             )
                                      )
                               )

# remove extra Dataset columns
dat_all <- dat_all %>%
  select(-Exposure.Dataset.Pilling, -Exposure.Dataset.Timmers, -Exposure.Dataset.Cases90, -Exposure.Dataset.Cases99)

```

## Filter by five Exposures

Table 1. Estimates for all Five Selected Exposures
```{r}
table1 <- dat_all %>%
  filter(exposure %in% c("Toenail selenium levels (unit increase)", "Thyroid peroxidase antibody levels", "Urinary albumin excretion (unit increase)", "Smoking status (ever vs never smokers) (unit increase)", "Rheumatoid arthritis (NA)"))

kbl(table1, booktabs = T)%>%
  kable_classic()
saveRDS(table1, "data/Tables/estimates_multiple_methods_select_exposures.rds" )
```

Table 2. Thyroid Specific Exposures

```{r}
TSH <- filter(dat_all, grepl("Thyroid stimulating hormone", exposure))

T4 <- filter(dat_all, grepl("thyroxine", exposure))

table2 <- dat_all %>%
  filter(exposure == "Thyroid peroxidase antibody levels") %>%
           rbind(TSH,T4)

kbl(table2, booktabs = T)%>%
  kable_classic()
```

# Scatter plots of all the Betas

## Selenium 

### reorganize data
```{r include=FALSE}
Selenium <- table1 %>%
  select(exposure, method,b.pilling, b.timmers, b.90, b.99)%>%
  filter(exposure == "Toenail selenium levels (unit increase)") 

sel.pilling <- Selenium %>%
  rename(Beta = b.pilling)%>%
  select(-b.timmers, -b.99,  -b.90)
sel.timmers<- Selenium %>%
    rename(Beta = b.timmers)%>%
  select( -b.99, -b.pilling, -b.90)
sel.90 <- Selenium %>%
  rename(Beta = b.90)%>%
  select(-b.timmers, -b.99, -b.pilling)
  
sel.99 <- Selenium %>%
  rename(Beta = b.99)%>%
  select(-b.timmers, -b.pilling, -b.90)

#column for outcome dataset
Outcome <- c(rep("Pilling", 5), rep("Timmers", 5), rep("Deleen 90", 5), rep("Deleen 99", 5))

selenium.plot.data <- rbind(sel.pilling, sel.timmers, sel.90, sel.99) %>% cbind(Outcome) %>%
  pivot_wider(names_from = method, values_from = Beta)%>%
  rename(IVW = `Inverse variance weighted`,
         Egger = `MR Egger`,
         Median = `Weighted median`)
```

### plot

```{r}
#IVW vs. MR Egger

p1 <- ggplot(selenium.plot.data)+
  geom_point(aes(x = IVW, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Egger")

# IVW vs Median
p2 <-ggplot(selenium.plot.data)+
  geom_point(aes(x = IVW, y = Median )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Median")

# Median vs. MR Egger
p3 <-ggplot(selenium.plot.data)+
  geom_point(aes(x = Median, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("Median vs. Egger")

p1 + p2 + p3  + plot_layout(nrow = 2) + 
  plot_annotation(caption = "Comparing Betas from multiple methods")
```

## 	Thyroid peroxidase antibody levels

### reorganize data
```{r include=FALSE}
Thyroid <- table1 %>%
  select(exposure, method,b.pilling, b.timmers, b.90, b.99)%>%
  filter(exposure == "Thyroid peroxidase antibody levels") 

thy.pilling <- Thyroid %>%
  rename(Beta = b.pilling)%>%
  select(-b.timmers, -b.99,  -b.90)
thy.timmers<- Thyroid %>%
    rename(Beta = b.timmers)%>%
  select( -b.99, -b.pilling, -b.90)
thy.90 <- Thyroid %>%
  rename(Beta = b.90)%>%
  select(-b.timmers, -b.99, -b.pilling)
  
thy.99 <- Thyroid %>%
  rename(Beta = b.99)%>%
  select(-b.timmers, -b.pilling, -b.90)

#column for outcome dataset
Outcome <- c(rep("Pilling", 5), rep("Timmers", 5), rep("Deleen 90", 5), rep("Deleen 99", 5))

Thyroid.plot.data <- rbind(thy.pilling, thy.timmers, thy.90, thy.99) %>% cbind(Outcome) %>%
  pivot_wider(names_from = method, values_from = Beta)%>%
  rename(IVW = `Inverse variance weighted`,
         Egger = `MR Egger`,
         Median = `Weighted median`)
```

### plot

```{r}
#IVW vs. MR Egger

p1 <- ggplot(Thyroid.plot.data)+
  geom_point(aes(x = IVW, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red") +
  ggtitle("IVW vs. Egger")

# IVW vs Median
p2 <- ggplot(Thyroid.plot.data)+
  geom_point(aes(x = IVW, y = Median )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Median")

# Median vs. MR Egger
p3 <-  ggplot(Thyroid.plot.data)+
  geom_point(aes(x = Median, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("Median vs. Egger")

p1 + p2 + p3  + plot_layout(nrow = 2) + 
  plot_annotation(caption = "Comparing Betas from multiple methods")
```


## Urinary albumin excretion (unit increase)

### reorganize data
```{r include=FALSE}
albumin <- table1 %>%
  select(exposure, method,b.pilling, b.timmers, b.90, b.99)%>%
  filter(exposure == "Urinary albumin excretion (unit increase)") 

albumin.pilling <- albumin %>%
  rename(Beta = b.pilling)%>%
  select(-b.timmers, -b.99,  -b.90)
albumin.timmers<- albumin %>%
    rename(Beta = b.timmers)%>%
  select( -b.99, -b.pilling, -b.90)
albumin.90 <- albumin %>%
  rename(Beta = b.90)%>%
  select(-b.timmers, -b.99, -b.pilling)
  
albumin.99 <- albumin %>%
  rename(Beta = b.99)%>%
  select(-b.timmers, -b.pilling, -b.90)

#column for outcome dataset
Outcome <- c(rep("Pilling", 5), rep("Timmers", 5), rep("Deleen 90", 5), rep("Deleen 99", 5))

albumin.plot.data <- rbind(albumin.pilling, albumin.timmers, albumin.90, albumin.99) %>% cbind(Outcome) %>%
  pivot_wider(names_from = method, values_from = Beta)%>%
  rename(IVW = `Inverse variance weighted`,
         Egger = `MR Egger`,
         Median = `Weighted median`)
```

### plot

```{r}
#IVW vs. MR Egger

p1 <- ggplot(albumin.plot.data)+
  geom_point(aes(x = IVW, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Egger")

# IVW vs Median
p2<-ggplot(albumin.plot.data)+
  geom_point(aes(x = IVW, y = Median )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Median")

# Median vs. MR Egger
  p3<- ggplot(albumin.plot.data)+
  geom_point(aes(x = Median, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("Median vs. Egger")
  
  p1 + p2 + p3  + plot_layout(nrow = 2) + 
  plot_annotation(caption = "Comparing Betas from multiple methods")
```

## 	Rheumatoid arthritis (NA)

### reorganize data
```{r include=FALSE}
RA <- table1 %>%
  select(exposure, method,b.pilling, b.timmers, b.90, b.99)%>%
  filter(exposure == "Rheumatoid arthritis (NA)") 

RA.pilling <- RA %>%
  rename(Beta = b.pilling)%>%
  select(-b.timmers, -b.99,  -b.90)
RA.timmers<- RA %>%
    rename(Beta = b.timmers)%>%
  select( -b.99, -b.pilling, -b.90)
RA.90 <- RA %>%
  rename(Beta = b.90)%>%
  select(-b.timmers, -b.99, -b.pilling)
  
RA.99 <- RA %>%
  rename(Beta = b.99)%>%
  select(-b.timmers, -b.pilling, -b.90)

#column for outcome dataset
Outcome <- c(rep("Pilling", 5), rep("Timmers", 5), rep("Deleen 90", 5), rep("Deleen 99", 5))

RA.plot.data <- rbind(RA.pilling, RA.timmers, RA.90, RA.99) %>% cbind(Outcome) %>%
  pivot_wider(names_from = method, values_from = Beta)%>%
  rename(IVW = `Inverse variance weighted`,
         Egger = `MR Egger`,
         Median = `Weighted median`)
```

### plot

```{r}
#IVW vs. MR Egger

p1<- ggplot(RA.plot.data)+
  geom_point(aes(x = IVW, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Egger")

# IVW vs Median
p2<-ggplot(RA.plot.data)+
  geom_point(aes(x = IVW, y = Median )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Median")
# Median vs. MR Egger
 p3<- ggplot(RA.plot.data)+
  geom_point(aes(x = Median, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("Median vs. Egger")
```


## Smoking status (ever vs never smokers) (unit increase)


### reorganize data
```{r include=FALSE}
smoke <- table1 %>%
  select(exposure, method,b.pilling, b.timmers, b.90, b.99)%>%
  filter(exposure == "Smoking status (ever vs never smokers) (unit increase)") 

smoke.pilling <- smoke %>%
  select(-b.timmers, -b.99,  -b.90)
smoke.timmers<- smoke %>%
  select( -b.99, -b.pilling, -b.90)
smoke.90 <- smoke %>%
  select(-b.timmers, -b.99, -b.pilling)
  
smoke.99 <- smoke %>%
  select(-b.timmers, -b.pilling, -b.90)

#column for outcome dataset
Outcome <- c(rep("Pilling", 5), rep("Timmers", 5), rep("Deleen 90", 5), rep("Deleen 99", 5))

smoke.plot.data <- rbind(RA.pilling, RA.timmers, RA.90, RA.99) %>% cbind(Outcome) %>%
  pivot_wider(names_from = method, values_from = Beta)%>%
  rename(IVW = `Inverse variance weighted`,
         Egger = `MR Egger`,
         Median = `Weighted median`)
```

### plot

```{r}
#IVW vs. MR Egger

p1<-ggplot(smoke.plot.data)+
  geom_point(aes(x = IVW, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Egger")

# IVW vs Median
p2<-ggplot(smoke.plot.data)+
  geom_point(aes(x = IVW, y = Median )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("IVW vs. Median")
# Median vs. MR Egger
p3<- ggplot(smoke.plot.data)+
  geom_point(aes(x = Median, y = Egger )) +
  geom_abline(intercept = 0, slope = 1, col = "red")+
  ggtitle("Median vs. Egger")
```



# Sensitivity Analysis
Harmonized data

```{r}
gwas <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
```

## filter only for five exposures

```{r}
harm_dat <- gwas %>%
  filter(exposure %in% c("Toenail selenium levels (unit increase)", "Thyroid peroxidase antibody levels", "Urinary albumin excretion (unit increase)", "Smoking status (ever vs never smokers) (unit increase)", "Rheumatoid arthritis (NA)"))

kbl(harm_dat, booktabs = T)%>%
  kable_classic()
```

## perform heterogeneity tests 

```{r}
kbl(mr_heterogeneity(harm_dat), booktabs = T)%>%
  kable_classic()
```

no indication of variation across studies

## horizontal pleiotropy

```{r}
kbl(mr_pleiotropy_test(harm_dat),  booktabs = T) %>%
  kable_classic()
```

intercepts no that much different than 0, so okay to use IVW?

## leave on out analysis

```{r}
kbl(mr_leaveoneout(harm_dat), booktabs = T) %>%
  kable_classic()
```

