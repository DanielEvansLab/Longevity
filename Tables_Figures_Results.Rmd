---
title: "Tables Figures and Results"
author: "Christine Le"
date: "11/4/2020"
output:
  word_document: default
  pdf_document: default
  html_document: default
always_allow_html: yes
---


```{r , include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(VennDiagram)
library(reactable)
library(tidyverse)
library(kableExtra)
library(TwoSampleMR)
library(patchwork)
library(cowplot)
library(gridExtra)
library(MRInstruments)
library(ggplot2)

#data



Pilling_dat <- readRDS("data/MR/Pilling_multtest_gwas_ieu.rds")
Timmers_dat <- readRDS("data/MR/Timmers_multtest_gwas_ieu.rds")
Cases90_dat <- readRDS("data/MR/Cases90_multtest_gwas_ieu.rds")
Cases99_dat <- readRDS("data/MR/Cases99_multtest_gwas_ieu.rds")
```




```{r results='hide', include=FALSE}
#merge all four outcomes
#Create a table containing adjusted p-values and information on exposure dataset, and outcome dataset sources
PillingA <- Pilling_dat %>% 
  filter(method == "Inverse variance weighted", exposure_dat != "methylation") %>%
  mutate(Pilling = "YES") %>%
  rename(Exposure.Dataset.Pilling = exposure_dat, Adjusted.p.Pilling = pval_BH, 
         b.pilling = b, se.pilling = se, nsnp.pilling = nsnp, pval.pilling = pval ) %>% 
  select(-id.exposure, -id.outcome, -outcome, -method) 
TimmersA <- Timmers_dat %>% 
  filter(method == "Inverse variance weighted") %>%
  mutate(Timmers = "YES") %>%
  rename(Exposure.Dataset.Timmers = exposure_dat, Adjusted.p.Timmers = pval_BH, 
         b.timmers = b, se.timmers = se, nsnp.timmers = nsnp, pval.timmers = pval) %>% 
  select(-id.exposure, -id.outcome, -outcome, -method) 
Cases90A <- Cases90_dat %>%
  filter(method == "Inverse variance weighted") %>%
  mutate(Cases90 = "YES") %>%
  rename(Exposure.Dataset.Cases90 = exposure_dat, Adjusted.p.Cases90 = pval_BH, 
         b.90 = b, se.90 = se, nsnp.90 = nsnp, pval.90 = pval) %>% 
  select(-id.exposure, -id.outcome, -outcome, -method)
Cases99A <- Cases99_dat %>%
  filter(method == "Inverse variance weighted") %>%
  mutate(Cases99 = "YES") %>%
  rename(Exposure.Dataset.Cases99 = exposure_dat, Adjusted.p.Cases99 = pval_BH,
         b.99 = b, se.99 = se, nsnp.99 = nsnp, pval.99 = pval) %>% 
  select(-id.exposure, -id.outcome, -outcome, -method)

dat_all <- merge(TimmersA, PillingA, by = "exposure", all = TRUE)
dat_all <- merge(dat_all, Cases90A, by = "exposure", all = TRUE)
dat_all <- merge(dat_all, Cases99A, by = "exposure", all = TRUE)


#replace NAs in Dataset columns with "NO"

dat_all$Pilling <- ifelse(is.na(dat_all$Pilling), "NO", dat_all$Pilling)
dat_all$Timmers <- ifelse(is.na(dat_all$Timmers), "NO", dat_all$Timmers)
dat_all$Cases90 <- ifelse(is.na(dat_all$Cases90), "NO", dat_all$Cases90)
dat_all$Cases99 <- ifelse(is.na(dat_all$Cases99), "NO", dat_all$Cases99)



#Make one Exposure Dataset column

dat_all$Exposure.Dataset <- ifelse(dat_all$Pilling == "YES", dat_all$Exposure.Dataset.Pilling,
                               ifelse(dat_all$Timmers == "YES", dat_all$Exposure.Dataset.Timmers,
                                      ifelse(dat_all$Cases90 == "YES", dat_all$Exposure.Dataset.Cases90,
                                             ifelse(dat_all$Cases99 == "YES", dat_all$Exposure.Dataset.Cases99, NA)
                                             )
                                      )
                               )






```



# Table1 in Four Parts.



```{r}
# Pilling significant for adjusted p-value <= 0.05 IVW only
table1a <- readRDS("data/MR/Pilling_multtest_gwas_ieu.rds")%>%
  filter(method == "Inverse variance weighted", pval_BH < 0.05) %>%
  select(-id.exposure, -id.outcome, -outcome, -method, - exposure_dat) 

# Timmers significant for adjusted p-value <= 0.05 IVW only
table1b <- readRDS("data/MR/Timmers_multtest_gwas_ieu.rds")%>%
  filter(method == "Inverse variance weighted", pval_BH < 0.05) %>%
  select(-id.exposure, -id.outcome, -outcome, -method, - exposure_dat)

# Deleen 90th percentile significant for adjusted p-value <= 0.05 IVW only
table1c <- readRDS("data/MR/Cases90_multtest_gwas_ieu.rds")%>%
  filter(method == "Inverse variance weighted", pval_BH < 0.05) %>%
  select(-id.exposure, -id.outcome, -outcome, -method, - exposure_dat)

# Deleen 90th percentile significant for adjusted p-value <= 0.05 IVW only
table1d <- readRDS("data/MR/Cases99_multtest_gwas_ieu.rds")%>%
  filter(method == "Inverse variance weighted", pval_BH < 0.05) %>%
  select(-id.exposure, -id.outcome, -outcome, -method, - exposure_dat)

table1 <- rbind(table1a, table1b, table1c, table1d)
# rename columns
colnames(table1)<- c("Exposure", "No of SNPs", "Beta", "SE", "p-value", "adjusted p-value")

##make a table
kbl(table1, booktabs = T, escape = F, row.names = FALSE)%>%
  kable_paper("striped", full_width = T)%>%
  pack_rows("Pilling", 1,379) %>%
  pack_rows("Timmers", 380, 1027) %>%
  pack_rows("Deleen 90th Percentile", 1028, 1281)%>%
  pack_rows("Deleen 99th Percentile",1282,1427 )
  
  
```

# Supplemntal Table 1. Exposures that are shared among all four studies with at least one significant association (adjusted p-value $\leq$ 0.05)


```{r ,include=FALSE}
#create groups

table5b_groups <- c(
"Neurological" ,                                                                                                                         
 "Age at first live birth || id:ukb-a-319" ,                                                                                                        
  "Age at first live birth || id:ukb-b-12405"    ,                                                                                                   
   "Age completed full time education || id:ukb-a-505" ,                                                                                              
  "Age completed full time education || id:ukb-b-6134" ,                                                                                             
"Behavioral",                                                                                             
"Cardiovascular Risk Factors" ,                                                                                              
  "Age started oral contraceptive pill || id:ukb-a-323" ,                                                                                            
   "Age when periods started (menarche) || id:ukb-a-315" ,                                                                                            
  "Age when periods started (menarche) || id:ukb-b-3768",                                                                                            
"Behavioral",                                                                                            
"Behavioral",                                                                                            
"Allergic disease (asthma, hay fever or eczema) || id:ebi-a-GCST005038"   ,                                                                        
"Neurological" ,                                                                                         
"Neurological" ,                                                                                             
"Neurological" ,                                                                                    
"Neurological" ,                                                                                                              
"Neurological" ,                                                                                                              
"Neurological" ,                                                                                                             
"Neurological" ,                                                                               
"Neurological" ,                                                                                                   
"Neurological" ,                                                                            
"Neurological" ,                                                                                                         
"Cardiovascular Outcome", 
"Ankle spacing width || id:ukb-b-4080",                                                                                                            
"Neurological" ,                                                                                                       
"Any ICDMAIN event in hilmo or causes of death || id:ukb-d-ICDMAIN_ANY_ENTRY"  ,                                                                   
"Apoliprotein A || id:ukb-d-30630_irnt"        ,                                                                                                   
 "Apoliprotein A || id:ukb-d-30630_raw"   ,                                                                                                         
 "Apoliprotein B || id:ukb-d-30640_irnt"   ,                                                                                                        
 "Apoliprotein B || id:ukb-d-30640_raw"   ,                                                                                                         
"Arm fat-free mass (left) || id:ukb-a-288",                                                                                                        
 "Arm fat-free mass (left) || id:ukb-b-19925" ,                                                                                                     
 "Arm fat-free mass (right) || id:ukb-a-284" ,                                                                                                      
 "Arm fat-free mass (right) || id:ukb-b-19520",                                                                                                     
 "Arm fat mass (left) || id:ukb-a-287"    ,                                                                                                         
 "Arm fat mass (left) || id:ukb-b-8338" ,                                                                                                           
 "Arm fat mass (right) || id:ukb-a-283"  ,                                                                                                          
  "Arm fat mass (right) || id:ukb-b-6704"  ,                                                                                                         
 "Arm fat percentage (left) || id:ukb-a-286"  ,                                                                                                     
 "Arm fat percentage (left) || id:ukb-b-20188"  ,                                                                                                   
 "Arm fat percentage (right) || id:ukb-a-282"  ,                                                                                                    
 "Arm fat percentage (right) || id:ukb-b-12854" ,                                                                                                   
"Arm predicted mass (left) || id:ukb-a-289" ,                                                                                                      
 "Arm predicted mass (left) || id:ukb-b-9093" ,                                                                                                     
 "Arm predicted mass (right) || id:ukb-a-285" ,                                                                                                     
 "Arm predicted mass (right) || id:ukb-b-16698" ,                                                                                                   
 "Cardiovascular Outcome",                                                                                                                       
"Respiratory",                                                                                                                  
"Respiratory" ,                                                                                                                
"Respiratory",                                                                                     
"Cardiovascular Outcome",                                                                                                               
"Cardiovascular Outcome",                                                                                                      
"Cardiovascular Outcome",                                                                                                       
"Cardiovascular Outcome",                                                                                                       
"Cardiovascular Outcome",                                                                                               
"Attendance/disability/mobility allowance: Blue badge || id:ukb-b-1867"   ,                                                                        
 "Attendance/disability/mobility allowance: Disability living allowance || id:ukb-b-20214"    ,                                                     
 "Attendance/disability/mobility allowance: None of the above || id:ukb-b-3855"     ,                                                               
 "Average total household income before tax || id:ukb-b-7408"     ,                                                                                 
"Behavioral",                                                                                          
"Basal metabolic rate || id:ukb-a-268" ,                                                                                                           
"Basal metabolic rate || id:ukb-b-16446" ,                                                                                                         
"Bipolar disorder || id:ebi-a-GCST003724"  ,                                                                                                       
 "Birth weight of first child || id:ukb-a-318" ,                                                                                                    
 "Birth weight of first child || id:ukb-b-3357" ,                                                                                                   
"Respiratory",                           
 "Blood clot  DVT  bronchitis  emphysema  asthma  rhinitis  eczema  allergy diagnosed by doctor: Blood clot in the lung || id:ukb-a-445" ,          
"Respiratory",                          
 "Blood clot, DVT, bronchitis, emphysema, asthma, rhinitis, eczema, allergy diagnosed by doctor: Blood clot in the leg (DVT) || id:ukb-b-11411" ,   
 "Blood clot, DVT, bronchitis, emphysema, asthma, rhinitis, eczema, allergy diagnosed by doctor: Blood clot in the lung || id:ukb-b-13704"  ,       
"Cardiovascular Risk Factors" ,                                                                                                             
"Cardiovascular Risk Factors" ,                                                                                                          
"Cardiovascular Risk Factors" ,                                                                                                         
"Cardiovascular Risk Factors" ,                                                                                                         
"Cardiovascular Risk Factors" ,                                                                                                          
"Cardiovascular Risk Factors" ,                                                                                                                    
"Cardiovascular Risk Factors" ,                                                                                                               
"Cardiovascular Risk Factors" ,                                                                                                           
"Cardiovascular Risk Factors" ,                                                                                                         
"Cardiovascular Risk Factors" ,                                                                                                                  
"Cardiovascular Risk Factors" ,                                                                                                                  
"Cardiovascular Risk Factors" ,                                                                                                                  
"Cardiovascular Risk Factors" ,                                                                                                                   
"Cardiovascular Risk Factors" ,                                                                                                                 
"Cardiovascular Risk Factors" ,                                                                                                                 
"Cardiovascular Risk Factors" ,                                                                                                                 
"Cancer",                                                                
"Cancer",                                                                                                          
"Cancer",                                                                                                          
"Cancer",                                                                                                         
"Cancer",                                                                                                     
"Cancer",                                                                                                                   
"Cancer",                                                                                                           
"Cancer",                                                                                                                   
"Biomarker",                                                                                                     
"Cancer",                                                                                        
"Cancer",                                                                                       
"Cancer",                                                                                      
"Cancer",                                                                                    
"Cancer",                                                                                                
"Cardiovascular Outcome",                                                                            
"Cardiovascular Outcome",                                                                            
"Cardiovascular Outcome",                                                                                                    
"Gastrointestinal",                                                                                                           
"Gastrointestinal",                                                                                                               
"Gastrointestinal",                                                                                                                
"Behavioral",                                                                                                        
"Neurological" ,                                                                                                               
"Behavioral",                                                                                                                
"Cardiovascular Risk Factors" ,                                                                                                            
"Cardiovascular Risk Factors" ,                                                                                                              
"Cardiovascular Risk Factors" ,                                                                                                             
"Cardiovascular Risk Factors" ,                                                                                                       
"Cardiovascular Risk Factors" ,                                                                                                      
"Behavioral",                                                                                                             
"Behavioral",                                                                   
"Neurological" ,                                                                                                    
"Gastrointestinal",                                                                                                              
"Cardiovascular Risk Factors" ,                                                                                                   
"Cardiovascular Risk Factors" ,                                                                                                
"Comparative height size at age 10 || id:ukb-a-35" ,                                                                                               
"Respiratory",                                                                                        
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
                                                                                               
"Cardiovascular Outcome", 
                                                                                                   
"Cardiovascular Outcome", 
                                                                                                           
"Cardiovascular Outcome", 
                                                                                                            
"Cardiovascular Outcome", 
                                                                                                            
"Cardiovascular Outcome", 
                                                                                                           
"Cardiovascular Outcome", 
                                                                               
"Behavioral",                                                                                                          
"Behavioral",                                                                                                        
"Biomarker",                                                                                                              
"Biomarker",                                                                                   
"Neurological" ,                                                                                                             
"Neurological" ,                                                                                                       
 "Destinations on discharge from hospital (recoded): Transfer to other NHS provider: General ward, young physically disabled, A&E || id:ukb-b-2399",
"Destinations on discharge from hospital (recoded): Usual Place of residence || id:ukb-b-11749"   ,                                                
"Diabetes diagnosed by doctor || id:ukb-a-306"  ,                                                                                                  
"Diabetes mellitus || id:finn-a-E4_DIABETES",                                                                                                      
 "Diabetes, varying definitions || id:finn-a-DIABETES_FG"  ,                                                                                        
"Cancer",                                                                         
"Diagnoses - main ICD10: C50.9 Breast, unspecified || id:ukb-b-2307" ,                                                                             
"Cancer",                                                                      
"Cancer",                                                                    
"Cancer",                                                                         
"Diagnoses - main ICD10: H26.9 Cataract, unspecified || id:ukb-b-12397" ,                                                                          
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Respiratory", 
"Respiratory", 
"Cardiovascular Outcome", 
"Diagnoses - main ICD10: I80.2 Phlebitis and thrombophlebitis of other deep vessels of lower extremities || id:ukb-b-12267" ,                      
"Respiratory",                                                                                        
"Gastrointestinal",
"Gastrointestinal",
"Diagnoses - main ICD10: M17 Gonarthrosis [arthrosis of knee] || id:ukb-a-563",                                                                  
"Diagnoses - main ICD10: M20 Acquired deformities of fingers and toes || id:ukb-a-564"   ,                                                         
"Diagnoses - main ICD10: N81 Female genital prolapse || id:ukb-a-577"   ,                                                                          
"Renal",
"Diagnoses - secondary ICD10: C77.3 Axillary and upper limb lymph nodes || id:ukb-b-1702",                                                         
"Diagnoses - secondary ICD10: E03.9 Hypothyroidism, unspecified || id:ukb-b-4226" ,                                                                
"Diagnoses - secondary ICD10: E11.9 Without complications || id:ukb-b-970"   ,                                                                     
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Respiratory", 
"Diagnoses - secondary ICD10: M10.99 Gout, unspecified (Site unspecified) || id:ukb-b-12765" ,                                                      
"Behavioral",
"Cardiovascular Risk Factors" , 
"Cancer", 
"Cardiovascular Risk Factors" , 
"Cardiovascular Drug",
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Behavioral",
"Behavioral",
"Cardiovascular Risk Factors" , 
"Diseases of veins, lymphatic vessels and lymph nodes, not elsewhere classified (FINNGEN) || id:finn-a-FG_DISVEINLYMPH" ,                          
"Disorders of lens || id:ukb-d-H7_LENS",                                                                                                            
"Respiratory", 
"Behavioral",
"Behavioral",
"Neurological" , 
"DVT of lower extremities and pulmonary embolism || id:finn-a-I9_DVTANDPULM"  ,                                                                    
 "DVT of lower extremities and pulmonary embolism || id:ukb-d-I9_DVTANDPULM"  ,                                                                     
"Cardiovascular Outcome", 
"Eosinophil percentage of granulocytes || id:ebi-a-GCST004617",                                                                                    
"Eosinophill percentage || id:ukb-d-30210_irnt"    ,                                                                                               
"Cancer", 
"Cancer", 
"Cancer", 
"Cancer", 
"Cancer", 
"Ever had corneal graft surgery: No || id:ukb-d-5328_0" ,                                                                                          
"Ever smoked || id:ukb-b-20261"        ,                                                                                                           
"Experiencing mood swings || id:ebi-a-GCST006944"  ,                                                                                                
"Exposure to tobacco smoke outside home || id:ukb-b-6244",                                                                                         
"Cardiovascular Risk Factors" , 
 "Eye problems/disorders: Diabetes related eye disease || id:ukb-a-423",                                                                            
"Falls in the last year || id:ukb-a-262"       ,                                                                                                   
"Falls in the last year || id:ukb-b-2535"   ,                                                                                                      
"Neurological" , 
"Parental Longevity",
"Parental Longevity",
"Fed-up feelings || id:ukb-a-49" ,                                                                                                                 
"Fed-up feelings || id:ukb-b-19809" ,                                                                                                              
"Feeling fed-up || id:ebi-a-GCST006947" ,                                                                                                          
"Neurological" , 
"Neurological" , 
"Respiratory", 
"Respiratory", 
"Behavioral",
"Frequency of tiredness / lethargy in last 2 weeks || id:ukb-a-245" ,                                                                              
"Frequency of tiredness / lethargy in last 2 weeks || id:ukb-b-929" ,                                                                              
"Frequency of unenthusiasm / disinterest in last 2 weeks || id:ukb-a-243" ,                                                                        
"Behavioral",
 "Glucose || id:ukb-d-30740_raw",                                                                                                                   
"Glycated haemoglobin || id:ukb-d-30750_irnt" ,                                                                                                    
"Glycated haemoglobin || id:ukb-d-30750_raw"  ,                                                                                                    
"Gonarthrosis [arthrosis of knee](FG) || id:ukb-d-KNEE_ARTHROSIS" ,                                                                                
"Gout-related co-morbidities || id:finn-a-GOUT_COMORB"  ,                                                                                          
"Haematocrit percentage || id:ukb-d-30030_irnt"  ,                                                                                                 
"Haemoglobin concentration || id:ukb-d-30020_irnt" ,                                                                                               
"Musculoskeletal",
"Musculoskeletal",
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
 "Height || id:ieu-a-1034"     ,                                                                                                                    
"Height || id:ieu-a-96"         ,                                                                                                                  
"Hemoglobin A1c || id:bbj-a-26"  ,                                                                                                                 
"Hemoglobin levels || id:ebi-a-GCST005060",                                                                                                        
"High light scatter reticulocyte count || id:ebi-a-GCST004611"  ,                                                                                  
"High light scatter reticulocyte count || id:ukb-d-30300_irnt"   ,                                                                                 
"High light scatter reticulocyte percentage || id:ukb-d-30290_irnt" ,                                                                              
"Hip circumference || id:ieu-a-48" ,                                                                                                               
"Hip circumference || id:ieu-a-49"  ,                                                                                                              
"Hip circumference || id:ieu-a-50"   ,                                                                                                             
"Hip circumference || id:ieu-a-51"    ,                                                                                                            
"Hip circumference || id:ukb-a-388"    ,                                                                                                           
"Hip circumference || id:ukb-b-15590"   ,                                                                                                          
"Home location at assessment - east co-ordinate (rounded) || id:ukb-b-1666"   ,                                                                    
"How are people in household related to participant: Husband, wife or partner || id:ukb-b-698",                                                    
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Illness  injury  bereavement  stress in last 2 years: None of the above || id:ukb-a-414" ,                                                        
"Illnesses of father: Alzheimer's disease/dementia || id:ukb-b-323"    ,                                                                           
"Illnesses of father: Heart disease || id:ukb-a-201"   ,                                                                                           
"Illnesses of father: Heart disease || id:ukb-b-18408" ,                                                                                           
"Illnesses of father: High blood pressure || id:ukb-a-207",                                                                                        
"Illnesses of father: High blood pressure || id:ukb-b-19456",                                                                                      
 "Illnesses of father: Lung cancer || id:ukb-a-205"     ,                                                                                           
"Illnesses of father: Lung cancer || id:ukb-b-14521" ,                                                                                             
"Illnesses of father: None of the above (group 1) || id:ukb-a-202" ,                                                                               
 "Illnesses of father: None of the above (group 1) || id:ukb-b-15169",                                                                              
"Illnesses of father: Prostate cancer || id:ukb-b-7773"    ,                                                                                       
"Illnesses of mother: Alzheimer's disease/dementia || id:ukb-a-210" ,                                                                              
"Illnesses of mother: Alzheimer's disease/dementia || id:ukb-b-14699",                                                                             
"Illnesses of mother: Breast cancer || id:ukb-a-213"   ,                                                                                           
 "Illnesses of mother: Breast cancer || id:ukb-b-13584" ,                                                                                           
"Illnesses of mother: Chronic bronchitis/emphysema || id:ukb-b-12018",                                                                             
"Illnesses of mother: Heart disease || id:ukb-a-209" ,                                                                                             
"Illnesses of mother: Heart disease || id:ukb-b-12477" ,                                                                                           
"Illnesses of mother: High blood pressure || id:ukb-a-215",                                                                                        
"Illnesses of mother: None of the above (group 1) || id:ukb-a-211" ,                                                                               
"Illnesses of mother: None of the above (group 1) || id:ukb-b-10454" ,                                                                             
"Illnesses of mother: None of the above (group 2) || id:ukb-b-16027" ,                                                                             
"Illnesses of siblings: Breast cancer || id:ukb-b-12227",                                                                                          
"Illnesses of siblings: Diabetes || id:ukb-b-18042" ,                                                                                              
"Illnesses of siblings: Heart disease || id:ukb-a-217",                                                                                            
"Illnesses of siblings: Heart disease || id:ukb-b-14371",                                                                                          
"Illnesses of siblings: High blood pressure || id:ukb-a-222",                                                                                      
"Illnesses of siblings: High blood pressure || id:ukb-b-8746",                                                                                     
"Illnesses of siblings: None of the above (group 1) || id:ukb-a-218",                                                                              
"Illnesses of siblings: None of the above (group 1) || id:ukb-b-17360",                                                                            
"Impedance of arm (left) || id:ukb-a-273" ,                                                                                                        
"Impedance of arm (left) || id:ukb-b-19379"  ,                                                                                                     
"Impedance of arm (right) || id:ukb-a-272" ,                                                                                                       
"Impedance of arm (right) || id:ukb-b-7859",                                                                                                       
"Impedance of leg (left) || id:ukb-a-271" ,                                                                                                        
"Impedance of leg (left) || id:ukb-b-14068",                                                                                                       
"Impedance of leg (right) || id:ukb-a-270",                                                                                                        
"Impedance of leg (right) || id:ukb-b-7376",                                                                                                       
"Impedance of whole body || id:ukb-a-269" ,                                                                                                        
"Impedance of whole body || id:ukb-b-19921",                                                                                                       
"Gastrointestinal",
"Insulin medication || id:finn-a-INSULINS" ,                                                                                                       
"Insulin, intermediate and long-acting || id:finn-a-INSULIN_INTER_AND_LONG" ,                                                                      
"Neurological" , 
 "Intended management of patient (recoded): No overnight hospital stay || id:ukb-b-14598",                                                          
"Iron || id:ieu-a-1049"  ,                                                                                                                         
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Job involves heavy manual or physical work || id:ukb-a-503" ,                                                                                     
"Job involves heavy manual or physical work || id:ukb-b-2002" ,                                                                                    
"Job involves mainly walking or standing || id:ukb-b-4461" ,                                                                                       
"Job involves shift work || id:ukb-b-1712"      ,                                                                                                  
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Leg fat-free mass (left) || id:ukb-a-280" ,                                                                                                       
"Leg fat-free mass (left) || id:ukb-b-16099" ,                                                                                                     
"Leg fat-free mass (right) || id:ukb-a-276"  ,                                                                                                     
"Leg fat-free mass (right) || id:ukb-b-12828" ,                                                                                                    
"Leg fat mass (left) || id:ukb-a-279"  ,                                                                                                           
"Leg fat mass (left) || id:ukb-b-7212" ,                                                                                                           
"Leg fat mass (right) || id:ukb-a-275" ,                                                                                                           
"Leg fat mass (right) || id:ukb-b-18096" ,                                                                                                         
 "Leg fat percentage (left) || id:ukb-a-278" ,                                                                                                      
 "Leg fat percentage (left) || id:ukb-b-18377" ,                                                                                                    
"Leg fat percentage (right) || id:ukb-a-274"  ,                                                                                                    
"Leg fat percentage (right) || id:ukb-b-20531" ,                                                                                                   
"Leg predicted mass (left) || id:ukb-a-281" ,                                                                                                      
"Leg predicted mass (left) || id:ukb-b-17271" ,                                                                                                    
 "Leg predicted mass (right) || id:ukb-a-277" ,                                                                                                     
"Leg predicted mass (right) || id:ukb-b-14310"  ,                                                                                                  
"Behavioral",
"Behavioral",
"Behavioral",
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Long-standing illness  disability or infirmity || id:ukb-a-252" ,                                                                                 
"Long-standing illness, disability or infirmity || id:ukb-b-13764" ,                                                                               
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Main speciality of consultant (recoded): Ophthalmology || id:ukb-b-9038" ,                                                                        
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cancer", 
"Cancer", 
"Cancer", 
"Cancer", 
"Maternal history of Alzheimer's disease || id:ebi-a-GCST005923",                                                                                  
 "Maternal smoking around birth || id:ukb-a-39"  ,                                                                                                  
"Maternal smoking around birth || id:ukb-b-17685",                                                                                                 
"Cardiovascular Risk Factors" , 
"Mean corpuscular hemoglobin concentration || id:bbj-a-39" ,                                                                                       
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Respiratory", 
"Medication related adverse effects || id:ukb-d-ASTHMA_MEDICATIO_COMORB" ,                                                                         
"Methods of discharge from hospital (recoded): Discharged on clinical advice/consent || id:ukb-b-5476",                                            
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Mood swings || id:ukb-a-45"  ,                                                                                                                    
"Mood swings || id:ukb-b-14180"   ,                                                                                                                
 "Mother's age || id:ukb-b-13686" ,                                                                                                                 
"Musculoskeletal",
"Musculoskeletal",
"Musculoskeletal",
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neutrophil percentage of granulocytes || id:ebi-a-GCST004623"  ,                                                                                  
"Behavioral",
"Behavioral",
"Nitrogen oxides air pollution; 2010 || id:ukb-b-12417" ,                                                                                          
"NODEamps100 0038 || id:ubm-a-929"     ,                                                                                                           
"NODEamps25 0002 || id:ubm-a-872" ,                                                                                                                
"NODEamps25 0017 || id:ubm-a-887" ,                                                                                                                
"Cardiovascular Risk Factors" , 
                                                                                  
"Respiratory", 
"Non-cancer illness code  self-reported: diabetes || id:ukb-a-74"  ,                                                                               
"Cardiovascular Outcome", 
"Cardiovascular Risk Factors" , 
                                                                       
"Cardiovascular Risk Factors" , 
                                                                           
 "Non-cancer illness code  self-reported: hypothyroidism/myxoedema || id:ukb-a-77"     ,                                                            
"Respiratory", 
"Cardiovascular Risk Factors" , 
                                                                            
"Respiratory", 
"Cardiovascular Outcome", 
"Non-cancer illness code, self-reported: deep venous thrombosis (dvt) || id:ukb-b-12040" ,                                                         
"Non-cancer illness code, self-reported: diabetes || id:ukb-b-12948"    ,                                                                          
"Cardiovascular Outcome", 
"Cardiovascular Risk Factors" , 
                                                                     
"Cardiovascular Risk Factors" , 
"Non-cancer illness code, self-reported: hyperthyroidism/thyrotoxicosis || id:ukb-b-20289",                                                        
 "Non-cancer illness code, self-reported: hypothyroidism/myxoedema || id:ukb-b-19732" ,                                                             
"Respiratory", 
"Musculoskeletal",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Number of full brothers || id:ukb-b-4263"  ,                                                                                                      
"Number of operations, self-reported || id:ukb-b-4733",                                                                                            
"Cancer",                                                                                               
"Cancer",                                                                                   
"Cancer",                                                                                    
"Number of treatments/medications taken || id:ukb-a-24" ,                                                                                          
"Number of treatments/medications taken || id:ukb-b-3656" ,                                                                                        
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Operation code: bunion/hallus valgus surgery || id:ukb-b-9190" ,                                                                                  
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Musculoskeletal",
"Musculoskeletal",
"Operation code: mastectomy || id:ukb-b-3083",                                                                                                     
"Operative procedures - main OPCS: B27.4 Total mastectomy NEC || id:ukb-b-20278"   ,                                                               
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Renal",
 "Operative procedures - secondary OPCS: T86.2 Sampling of axillary lymph nodes || id:ukb-b-18953",                                                 
"Operative procedures - secondary OPCS: T87.3 Excision or biopsy of axillary lymph node || id:ukb-b-93" ,                                          
 "Operative procedures - secondary OPCS: Y02.2 Insertion of prosthesis into organ NOC || id:ukb-b-1744" ,                                           
"Operative procedures - secondary OPCS: Z94.2 Right sided operation || id:ukb-b-6222" ,                                                            
"Other degenerative diseases of the nervous system || id:finn-a-G6_NEURODEG" ,                                                                     
"Other degenerative diseases of the nervous system || id:finn-a-NEURODEGOTH" ,                                                                    
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Musculoskeletal",
"Otosclerosis || id:finn-a-H8_OTOSCLE" ,                                                                                                           
"Overall health rating || id:ukb-a-251"   ,                                                                                                        
"Overall health rating || id:ukb-b-6306" ,                                                                                                         
"Cardiovascular Risk Factors" , 
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Pain type(s) experienced in last month: None of the above || id:ukb-b-9130" ,                                                                     
"Parental Longevity",
"Parental Longevity",
"Parental Longevity",
"Parental Longevity",
"Parental Longevity",
"Parental Longevity",
"Behavioral",
"Behavioral",
"Paternal history of Alzheimer's disease || id:ebi-a-GCST005920"  ,                                                                                
"PCT where patients GP was registered: SUNDERLAND TEACHING PCT || id:ukb-b-20168" ,                                                                
"Peak expiratory flow (PEF) || id:ukb-b-12019" ,                                                                                                   
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Place of birth in UK - east co-ordinate || id:ukb-b-13231" ,                                                                                      
"Place of birth in UK - north co-ordinate || id:ukb-b-1431" ,                                                                                      
"Cancer", 
"Respiratory", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Neurological" , 
"Reticulocyte count || id:ukb-d-30250_irnt",                                                                                                       
"Reticulocyte percentage || id:ukb-d-30240_irnt",                                                                                                  
"Musculoskeletal",
"Musculoskeletal",
"Musculoskeletal",
"Musculoskeletal",
"Musculoskeletal",
"Musculoskeletal",
"Musculoskeletal",
"Musculoskeletal",
"Behavioral",
"Seen a psychiatrist for nerves, anxiety, tension or depression || id:ukb-b-18336",                                                                
 "Seen doctor (GP) for nerves, anxiety, tension or depression || id:ukb-b-6991",                                                                    
"SHBG || id:ukb-d-30830_irnt"  ,                                                                                                                   
"SHBG || id:ukb-d-30830_raw"   ,                                                                                                                   
"SLE-related co-morbidities || id:finn-a-SLE_COMORB" ,                                                                                             
"Sleep duration || id:ukb-a-9"          ,                                                                                                          
"Sleep duration || id:ukb-b-4424",                                                                                                                 
"Behavioral",
"Behavioral",
"Sources of admission to hospital (recoded): Usual Place of residence || id:ukb-b-20172" ,                                                         
"Spells in hospital || id:ukb-b-1260"      ,                                                                                                       
"Cancer", 
 "Stroke || id:ebi-a-GCST005838"  ,                                                                                                                 
"Stroke || id:ebi-a-GCST006906" ,                                                                                                                  
"Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified || id:ukb-d-XVIII_MISCFINDINGS"   ,                       
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Taking other prescription medications || id:ukb-a-310" ,                                                                                          
"Taking other prescription medications || id:ukb-b-20292" ,                                                                                        
"Behavioral",
"Behavioral",
"Behavioral",                                                                                                   
"Behavioral",                                                                                                  
"Behavioral",                                                                                                       
"Behavioral",                                                                                                     
"Behavioral",                                                                                               
"Behavioral",                                                                                          
"Cardiovascular Risk Factors" , 
                                                                                                               
"Cardiovascular Risk Factors" , 
                                                                                                               
"Cardiovascular Risk Factors" , 
                                                                                                            
"Townsend deprivation index at recruitment || id:ukb-a-44"    ,                                                                                    
"Townsend deprivation index at recruitment || id:ukb-b-10011"   ,                                                                                  
"Transport type for commuting to job workplace: Cycle || id:ukb-b-15787"    ,                                                                      
"Treatment speciality of consultant (recoded): Cardiology || id:ukb-b-20300" ,                                                                     
"Treatment speciality of consultant (recoded): General medicine || id:ukb-b-12646" ,                                                               
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Treatment/medication code: levothyroxine sodium || id:ukb-a-190" ,                                                                                
 "Treatment/medication code: levothyroxine sodium || id:ukb-b-17918" ,                                                                              
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Cardiovascular Drug",
"Treatment/medication code: rhinocort 50micrograms nasal spray || id:ukb-a-144" ,                                                                  
"Cardiovascular Drug",
 "Treatment/medication code: seretide 50 evohaler || id:ukb-b-17836"  ,                                                                             
"Cardiovascular Drug",
"Cardiovascular Drug",
"Treatment/medication code: ventolin 100micrograms inhaler || id:ukb-a-122" ,                                                                      
"Treatment/medication code: ventolin 100micrograms inhaler || id:ukb-b-13148" ,                                                                    
"Cardiovascular Drug",
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Trunk fat-free mass || id:ukb-a-292",                                                                                                             
"Trunk fat-free mass || id:ukb-b-17409",                                                                                                           
"Trunk fat mass || id:ukb-a-291"   ,                                                                                                               
"Trunk fat mass || id:ukb-b-20044" ,                                                                                                               
"Trunk fat percentage || id:ukb-a-290"  ,                                                                                                          
"Trunk fat percentage || id:ukb-b-16407"  ,                                                                                                        
"Trunk predicted mass || id:ukb-a-293"   ,                                                                                                         
"Trunk predicted mass || id:ukb-b-9685"  ,                                                                                                         
"Type 1 diabetes || id:ebi-a-GCST005536"      ,                                                                                                    
"Type 1 diabetes with ketoacidosis || id:finn-a-E4_DM1KETO" ,                                                                                      
 "Type 2 diabetes || id:bbj-a-153" ,                                                                                                                
 "Type 2 Diabetes || id:bbj-a-77" ,                                                                                                                 
"Type 2 diabetes || id:ebi-a-GCST005047",                                                                                                          
"Type 2 diabetes || id:ebi-a-GCST005413" ,                                                                                                         
"Type 2 diabetes || id:ebi-a-GCST006867" ,                                                                                                         
"Type 2 diabetes || id:ieu-a-23"    ,                                                                                                              
"Type 2 diabetes || id:ieu-a-24" ,                                                                                                                 
"Type 2 diabetes || id:ieu-a-25"  ,                                                                                                                
 "Type 2 diabetes || id:ieu-a-26"  ,                                                                                                                
"Type 2 diabetes, definitions combined || id:finn-a-T2D"   ,                                                                                       
"Type 2 diabetes, strict (exclude DM1) || id:finn-a-E4_DM2_STRICT"  ,                                                                              
"Cancer", 
"Cancer", 
"Cancer", 
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
"Behavioral",
 "Types of transport used (excluding work): Cycle || id:ukb-b-17557" ,                                                                              
"Renal",
"Renal",
"Renal",
"Behavioral",
"Behavioral",
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Cardiovascular Outcome", 
"Venous thromboembolism || id:finn-a-I9_VTE"  ,                                                                                                    
"Venous thromboembolism || id:ukb-d-I9_VTE"    ,                                                                                                   
"Vitamin and mineral supplements: Multivitamins +/- minerals || id:ukb-b-16812" ,                                                                  
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Behavioral",
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Respiratory", 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Cardiovascular Risk Factors" , 
"Workplace very hot: Rarely/never || id:ukb-d-22608_0",                                                                                            
 "Worry too long after embarrassment || id:ukb-a-53",                                                                                               
"Years of schooling || id:ieu-a-1001",                                                                                                             
"Years of schooling || id:ieu-a-1010"  ,                                                                                                           
"Years of schooling || id:ieu-a-1011"  ,                                                                                                           
 "Years of schooling || id:ieu-a-1239" ,                                                                                                            
"Years of schooling || id:ieu-a-755" )
```

```{r, include= FALSE}
table.1 <- dat_all %>% filter(Pilling == "YES" & Timmers == "YES" & Cases90 == "YES" & Cases99 == "YES") %>% 
  filter(Adjusted.p.Pilling <= 0.05 | Adjusted.p.Timmers <= 0.05 | Adjusted.p.Cases90 <= 0.05 | Adjusted.p.Cases99 <= 0.05) %>%
  mutate(Groups = table5b_groups)%>%
  select(Groups, exposure,  b.pilling, b.timmers,  b.90, b.99, se.pilling, se.timmers, se.90, se.99, nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99,pval.pilling, pval.timmers,  pval.90,  pval.99, Adjusted.p.Pilling,  Adjusted.p.Timmers,  Adjusted.p.Cases90,  Adjusted.p.Cases99, Exposure.Dataset)
```




```{r, include= FALSE}
#conditional formatting

table.1$Adjusted.p.Pilling <- round(table.1$Adjusted.p.Pilling, digits = 5)%>% 
  cell_spec(color = ifelse(table.1$Adjusted.p.Pilling > 0.05,"red", "green"))

table.1$Adjusted.p.Timmers <- round(table.1$Adjusted.p.Timmers, digits = 5)%>% 
  cell_spec( color = ifelse(table.1$Adjusted.p.Timmers > 0.05,"red", "green"))

table.1$Adjusted.p.Cases90<- round(table.1$Adjusted.p.Cases90, digits = 5)%>% 
  cell_spec( color = ifelse(table.1$Adjusted.p.Cases90 > 0.05,"red", "green"))

table.1$Adjusted.p.Cases99 <- round(table.1$Adjusted.p.Cases99, digits = 5)%>% 
  cell_spec(color = ifelse(table.1$Adjusted.p.Cases99 > 0.05,"red", "green"))
```




```{r, include= FALSE}
#label columns
colnames(table.1) <- c("Groups", "Exposure", "Pilling", "Timmers", "90th Percentile", "99th Percentile","Pilling", "Timmers", "90th Percentile", "99th Percentile","Pilling", "Timmers", "90th Percentile", "99th Percentile","Pilling", "Timmers", "90th Percentile", "99th Percentile", "Pilling", "Timmers", "90th Percentile", "99th Percentile","Exposure Dataset")

```




```{r}
#create table
new_tab <- table.1[order(table.1$Groups),]

kbl(new_tab,booktabs = T, escape = F, row.names = FALSE, digits = 5) %>%
    add_header_above(c(" " = 2, "Beta"= 4, "SE"= 4,"No. SNPs" =4, "p-value" = 4, "Adjusted p-value"= 4, " " = 1))%>%
  kable_paper("striped", full_width = T)

```

# Table 2.Selected Exposures

```{r}
sel_tab <- dat_all %>% filter(Pilling == "YES" & Timmers == "YES" & Cases90 == "YES" & Cases99 == "YES") %>% 
  filter(Adjusted.p.Pilling <= 0.05 | Adjusted.p.Timmers <= 0.05 | Adjusted.p.Cases90 <= 0.05 | Adjusted.p.Cases99 <= 0.05) %>%
  mutate(Groups = table5b_groups)%>%
  select(Groups, exposure,  b.pilling, b.timmers,  b.90, b.99, se.pilling, se.timmers, se.90, se.99, nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99,pval.pilling, pval.timmers,  pval.90,  pval.99, Adjusted.p.Pilling,  Adjusted.p.Timmers,  Adjusted.p.Cases90,  Adjusted.p.Cases99, Exposure.Dataset)%>%
   filter(exposure %in% c( ))
 
sel_graph <- sel_tab  
sel_tab$Adjusted.p.Pilling <- round(sel_tab$Adjusted.p.Pilling, digits = 5) %>% cell_spec( color = ifelse(sel_tab$Adjusted.p.Pilling > 0.05,"red", "green"))

sel_tab$Adjusted.p.Timmers <- round(sel_tab$Adjusted.p.Timmers, digits = 5) %>%
  cell_spec( color = ifelse(sel_tab$Adjusted.p.Timmers < 0.05,"green", "red"))

sel_tab$Adjusted.p.Cases90<- round(sel_tab$Adjusted.p.Cases90, digits = 5) %>% cell_spec( color = ifelse(sel_tab$Adjusted.p.Cases90 > 0.05,"red", "green"))

sel_tab$Adjusted.p.Cases99 <- round(sel_tab$Adjusted.p.Cases99, digits = 5) %>% cell_spec( color = ifelse(sel_tab$Adjusted.p.Cases99 > 0.05,"red", "green"))  


colnames(sel_tab) <- c("Groups", "Exposure", "Pilling", "Timmers", "90th Percentile", "99th Percentile","Pilling", "Timmers", "90th Percentile", "99th Percentile","Pilling", "Timmers", "90th Percentile", "99th Percentile", "Pilling", "Timmers", "90th Percentile", "99th Percentile","Pilling", "Timmers", "90th Percentile", "99th Percentile", "Exposure Dataset")
  
kbl(sel_tab,booktabs = T, escape = F, row.names = FALSE) %>%
  add_header_above(c(" " = 2, "Beta"= 4, "SE"= 4, "No. of SNPS" = 4, "p-value" = 4, "Adjusted p-value"= 4, " " = 1)) %>%
  kable_paper("striped", full_width = T)
  

```


# Functions
## for 2x2 LOO plots
Modify function from TwoSampleMR Package

```{r }
res <-  function(d, x, title) # must use data filtered by outcome
	{
    d <- dplyr::filter(d, `Longevity Definition` == x)
		d <- plyr::mutate(d)  
		# Need to have at least 3 SNPs because IVW etc methods can't be performed with fewer than 2 SNPs
		if(sum(!grepl("All", d$SNP)) < 3) {
			return(
				ggplot() +
  annotate("text", x = 0, y = 0, label = "Insufficient number of SNPs")+
  theme(legend.position = "none", 
		        axis.text.y = element_text(size =6), 
		        axis.ticks.y = element_line(size =0),
		        axis.title.x = element_text(size =8),
		        panel.border = element_blank(),
		        panel.grid.major = element_blank(),
		        panel.grid.minor = element_blank(),
		        panel.background = element_blank())+
		  labs(y = "", title = title))
			
		}
		else {
		d$up <- d$Beta + 1.96 * d$SE
		d$lo <- d$Beta - 1.96 * d$SE
		d$tot <- 1
		d$tot[d$SNP != "All"] <- 0.01
		d$SNP <- as.character(d$SNP)
		nom <- d$SNP[d$SNP != "All"]
		nom <- nom[order(d$Beta)]
		d <- rbind(d, d[nrow(d),])
		d$SNP[nrow(d)-1] <- ""
		d$Beta[nrow(d)-1] <- NA
		d$up[nrow(d)-1] <- NA
		d$lo[nrow(d)-1] <- NA
		d$SNP <- factor(d$SNP, levels=c("All" , "", nom))
		
		
		plot <- ggplot(d, aes(x = Beta, y = SNP)) +
		  geom_vline(xintercept = 0, linetype = "dotted") + 
		  geom_errorbarh(aes(xmin = lo, xmax = up, size = as.factor(tot), colour = as.factor(tot)), height = 0, na.rm = TRUE) + 
		  geom_point(aes(color = as.factor(tot)),  na.rm = TRUE)+ 
		  geom_hline(aes(yintercept = which(levels(SNP) %in% "")), color = "grey") +
		  scale_colour_manual(values = c("black", "red")) +
		  scale_size_manual(values =  c(0.3,1))+ 
		  theme(legend.position = "none", 
		        axis.text.y = element_text(size =6), 
		        axis.ticks.y = element_line(size =0),
		        axis.title.x = element_text(size =8),
		        panel.border = element_blank(),
		        panel.grid.major = element_blank(),
		        panel.grid.minor = element_blank(),
		        panel.background = element_blank())+
		  labs(y = "", title = title)
		return(plot)
		}
}
```

Make a function for all four outcomes!

```{r }
#doo for all individual LOO tables 1 -15

loo_graphs <- function(loo_test, exposure, outcome){
library(patchwork)
plot1 <- res(loo_test, "Pilling", "(a) Pilling")
plot2 <- res(loo_test, "Timmers", "(b) Timmers")
plot3 <- res(loo_test, "Cases90", "(c) Deleen 90th Percentile")
plot4 <- res(loo_test, "Cases99", "(d) Deleen 90th Percentile")

plot1 + plot2 + plot3 + plot4 + plot_layout(nrow = 2) + 
  plot_annotation(caption = paste0("MR leave-one-out sensitivity analysis for ", exposure, " on ", outcome))
}
```

## Function for scatter plot of three methods 2x2

### Legend
```{r}
# Modify mr_scatter_plot function for our purposes

mrscatter_legend <- function(mr_results, dat, title)
{
	# dat <- subset(dat, paste(id.outcome, id.exposure) %in% paste(mr_results$id.outcome, mr_results$id.exposure))
	requireNamespace("ggplot2", quietly=TRUE)
	requireNamespace("plyr", quietly=TRUE)
	mrres <- plyr::dlply(dat, c("id.exposure", "id.outcome"), function(d)
	{
		d <- plyr::mutate(d)
		if(nrow(d) < 2 | sum(d$mr_keep) == 0)
		{
			return(blank_plot("Insufficient number of SNPs"))
		}
		d <- subset(d, mr_keep)
		index <- d$beta.exposure < 0
		d$beta.exposure[index] <- d$beta.exposure[index] * -1
		d$beta.outcome[index] <- d$beta.outcome[index] * -1
		mrres <- subset(mr_results, id.exposure == d$id.exposure[1] & id.outcome == d$id.outcome[1])
		mrres$a <- 0
		if("MR Egger" %in% mrres$method)
		{
			temp <- mr_egger_regression(d$beta.exposure, d$beta.outcome, d$se.exposure, d$se.outcome, default_parameters())
			mrres$a[mrres$method == "MR Egger"] <- temp$b_i
		}

		if("MR Egger (bootstrap)" %in% mrres$method)
		{
			temp <- mr_egger_regression_bootstrap(d$beta.exposure, d$beta.outcome, d$se.exposure, d$se.outcome, default_parameters())
			mrres$a[mrres$method == "MR Egger (bootstrap)"] <- temp$b_i
		}

		ggplot2::ggplot(data=d, ggplot2::aes(x=beta.exposure, y=beta.outcome)) +
			ggplot2::geom_errorbar(ggplot2::aes(ymin=beta.outcome-se.outcome, ymax=beta.outcome+se.outcome), colour="grey", width=0) +
			ggplot2::geom_errorbarh(ggplot2::aes(xmin=beta.exposure-se.exposure, xmax=beta.exposure+se.exposure), colour="grey", height=0) +
			ggplot2::geom_point(ggplot2::aes(text=paste("SNP:", SNP))) +
			ggplot2::geom_abline(data=mrres, ggplot2::aes(intercept=a, slope=b, colour=method), show.legend=TRUE) +
			ggplot2::scale_colour_manual(values=c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", "#cab2d6", "#6a3d9a", "#ffff99", "#b15928")) +
			ggplot2::labs(colour="MR Test", x = "", y=paste("SNP effect on", d$outcome[1]), title = title) +
			ggplot2::theme(legend.position= c(-.1,-.3), legend.key = element_rect(fill = alpha("white" , 0.1)), legend.background = element_rect(fill = alpha("white" , 0.1)), legend.title = element_text(size = 4), legend.text = element_text(size =4)) +
			ggplot2::guides(colour=ggplot2::guide_legend(ncol=3))
	})
	mrres
}


blank_plot <- function(message)
{
	requireNamespace("ggplot2", quietly=TRUE)
	ggplot2::ggplot(data.frame(a=0,b=0,n=message)) + ggplot2::geom_text(ggplot2::aes(x=a,y=b,label=n)) + ggplot2::labs(x=NULL,y=NULL) + ggplot2::theme(axis.text=ggplot2::element_blank(), axis.ticks=ggplot2::element_blank())
}



```
### No legend

```{r}
mrscatter_nolegend <- function(mr_results, dat, title)
{
	# dat <- subset(dat, paste(id.outcome, id.exposure) %in% paste(mr_results$id.outcome, mr_results$id.exposure))
	requireNamespace("ggplot2", quietly=TRUE)
	requireNamespace("plyr", quietly=TRUE)
	mrres <- plyr::dlply(dat, c("id.exposure", "id.outcome"), function(d)
	{
		d <- plyr::mutate(d)
		if(nrow(d) < 2 | sum(d$mr_keep) == 0)
		{
			return(blank_plot("Insufficient number of SNPs"))
		}
		d <- subset(d, mr_keep)
		index <- d$beta.exposure < 0
		d$beta.exposure[index] <- d$beta.exposure[index] * -1
		d$beta.outcome[index] <- d$beta.outcome[index] * -1
		mrres <- subset(mr_results, id.exposure == d$id.exposure[1] & id.outcome == d$id.outcome[1])
		mrres$a <- 0
		if("MR Egger" %in% mrres$method)
		{
			temp <- mr_egger_regression(d$beta.exposure, d$beta.outcome, d$se.exposure, d$se.outcome, default_parameters())
			mrres$a[mrres$method == "MR Egger"] <- temp$b_i
		}

		if("MR Egger (bootstrap)" %in% mrres$method)
		{
			temp <- mr_egger_regression_bootstrap(d$beta.exposure, d$beta.outcome, d$se.exposure, d$se.outcome, default_parameters())
			mrres$a[mrres$method == "MR Egger (bootstrap)"] <- temp$b_i
		}

		ggplot2::ggplot(data=d, ggplot2::aes(x=beta.exposure, y=beta.outcome)) +
			ggplot2::geom_errorbar(ggplot2::aes(ymin=beta.outcome-se.outcome, ymax=beta.outcome+se.outcome), colour="grey", width=0) +
			ggplot2::geom_errorbarh(ggplot2::aes(xmin=beta.exposure-se.exposure, xmax=beta.exposure+se.exposure), colour="grey", height=0) +
			ggplot2::geom_point(ggplot2::aes(text=paste("SNP:", SNP))) +
			ggplot2::geom_abline(data=mrres, ggplot2::aes(intercept=a, slope=b, colour=method), show.legend=TRUE) +
			ggplot2::scale_colour_manual(values=c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", "#cab2d6", "#6a3d9a", "#ffff99", "#b15928")) +
			ggplot2::labs(colour="MR Test", x=paste(""), y=paste("SNP effect on", d$outcome[1]), title = title) +
			ggplot2::theme(legend.position="none")
	})
	mrres
}


blank_plot <- function(message)
{
	requireNamespace("ggplot2", quietly=TRUE)
	ggplot2::ggplot(data.frame(a=0,b=0,n=message)) + ggplot2::geom_text(ggplot2::aes(x=a,y=b,label=n)) + ggplot2::labs(x=NULL,y=NULL) + ggplot2::theme(axis.text=ggplot2::element_blank(), axis.ticks=ggplot2::element_blank())
}


```

# Alzheimer's 1

```{r}
betas <- sel_graph %>%
  filter(exposure == c("Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c( "Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data1 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data1
ggplot(graph.data1) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Alzheimer's disease or family history of Alzheimer's disease (NR z-unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test1 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test1, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test1 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test1, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test1 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)

p1 <- mr_leaveoneout_plot(loo.pilling)
p2 <- mr_leaveoneout_plot(loo.timmers)
p3 <- mr_leaveoneout_plot(loo.cases90)
p4 <- mr_leaveoneout_plot(loo.cases99)

p1 <- grid.arrange(grobs = p1)
p2 <- grid.arrange(grobs = p2)
p3 <- grid.arrange(grobs = p3)
p4 <- grid.arrange(grobs = p4)
```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test1, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter1 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter1)
# mr_scatter_plot(mr.timmers, Timmers_harm_dat)
# to check if the graph is the same
ggsave("images/Alzheimers_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Alzheimer's disease or family history of Alzheimer's disease")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Alzheimer's disease or family history of Alzheimer's disease")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Alzheimer's disease or family history of Alzheimer's disease")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Alzheimer's disease or family history of Alzheimer's disease")
```

SNPs from Pilling (n=13). SNPs from Timmers (n= 15), Deleen 90th percentile (n=14) and Deleen 99th percentile (n=14) are from two studies0.

PubmedID : 30617256
Ass# GCST007320

PubmedID : 29777097	
Ass# GCST005922


# Thyroid Peroxidase 2
```{r}
betas <- sel_graph %>%
  filter(exposure %in% c("Thyroid peroxidase antibody levels"))%>%
  select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
   filter(exposure %in% c("Thyroid peroxidase antibody levels"))%>%
  select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure %in% c("Thyroid peroxidase antibody levels"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c( "Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Thyroid peroxidase antibody levels")
graph.data <- as.data.frame(cbind(Outcome, exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data2 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data
ggplot(graph.data2) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Thyroid peroxidase antibody levels")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Thyroid peroxidase antibody levels")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Thyroid peroxidase antibody levels")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Thyroid peroxidase antibody levels")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test2 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test2, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test2 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test2, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test2 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)

p1 <- mr_leaveoneout_plot(loo.pilling)
p2 <- mr_leaveoneout_plot(loo.timmers)
p3 <- mr_leaveoneout_plot(loo.cases90)
p4 <- mr_leaveoneout_plot(loo.cases99)

p1 <- grid.arrange(grobs = p1)
p2 <- grid.arrange(grobs = p2)
p3 <- grid.arrange(grobs = p3)
p4 <- grid.arrange(grobs = p4)
```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test2, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter2 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter2)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)

ggsave("images/Thyroid_scatter.png")
```


## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Thyroid peroxidase antibody levels")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Thyroid peroxidase antibody levels")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Thyroid peroxidase antibody levels")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Thyroid peroxidase antibody levels")
```

SNPs from Pilling (n=2). SNPs from Timmers (n= 4), Deleen 90th percentile (n=3) and Deleen 99th percentile (n=3) are from the same study.

PubmedID : 24586183
Ass# GCST002373

# Rheumatoid Arthritis 3

```{r}
betas <- sel_graph %>%
  filter(exposure == "Rheumatoid arthritis (NA)")%>%
  select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == "Rheumatoid arthritis (NA)")%>%
  select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == "Rheumatoid arthritis (NA)")%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()
  
Outcome <- c( "Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure = c("Rheumatoid arthritis (NA)")
graph.data <- as.data.frame(cbind(Outcome, exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data3 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data
ggplot(graph.data3) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```




## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Rheumatoid arthritis (NA)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Rheumatoid arthritis (NA)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure =="Rheumatoid arthritis (NA)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Rheumatoid arthritis (NA)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test3 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test3, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Pilling data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test3 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test3, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test3 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)

p1 <- mr_leaveoneout_plot(loo.pilling)
p2 <- mr_leaveoneout_plot(loo.timmers)
p3 <- mr_leaveoneout_plot(loo.cases90)
p4 <- mr_leaveoneout_plot(loo.cases99)

p1 <- grid.arrange(grobs = p1)
p2 <- grid.arrange(grobs = p2)
p3 <- grid.arrange(grobs = p3)
p4 <- grid.arrange(grobs = p4)
```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test3, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap with IVW estimate. However, Pilling data has fewer SNPs overall, with one SNP, rs6679677, whose point estimate is outside the IVW estimate.


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter3 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter3)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)

ggsave("images/RA_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Rheumatoid arthritis")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Rheumatoid arthritis")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Rheumatoid arthritis")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Rheumatoid arthritis")
```


```{r eval = FALSE}

## issues with population save all four as csv for reference and further examination

# write_csv(pilling_exp_data, "RA-SNP-population/pilling_exp_data.csv")
# write_csv(timmers_exp_data, "RA-SNP-population/timmers_exp_data.csv")
# write_csv(cases90_exp_data, "RA-SNP-population/cases90_exp_data.csv")
# write_csv(cases99_exp_data, "RA-SNP-population/cases99_exp_data.csv")
```

SNPs from Pilling (n=4) from 3 studies. SNPs from Timmers (n= 42), Deleen 90th percentile (n=42) and Deleen 99th percentile (n=42)

- Disucss with Dan. Issues about population from which exposures come from. 

# Urinary Albumin 4

```{r}
betas <- sel_graph %>%
  filter(exposure == "Urinary albumin excretion (unit increase)")%>%
  dplyr::select(b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == "Urinary albumin excretion (unit increase)")%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == "Urinary albumin excretion (unit increase)")%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()
Outcome <- c( "Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure = c("Urinary albumin excretion (unit increase)")
graph.data <- as.data.frame(cbind(Outcome, exposure,  betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data4 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data4
ggplot(graph.data4) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Urinary albumin excretion (unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Urinary albumin excretion (unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Urinary albumin excretion (unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Urinary albumin excretion (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test4 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  dplyr::select(-id.exposure, -id.outcome, -outcome) %>%
  dplyr::select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test4, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test4 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  dplyr::select(-id.exposure, -id.outcome, -outcome) %>%
  dplyr::select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test4, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test4 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  dplyr::select(-id.exposure, -id.outcome, -outcome) %>%
  dplyr::select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)

p1 <- mr_leaveoneout_plot(loo.pilling)
p2 <- mr_leaveoneout_plot(loo.timmers)
p3 <- mr_leaveoneout_plot(loo.cases90)
p4 <- mr_leaveoneout_plot(loo.cases99)

p1 <- grid.arrange(grobs = p1)
p2 <- grid.arrange(grobs = p2)
p3 <- grid.arrange(grobs = p3)
p4 <- grid.arrange(grobs = p4)
```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test4, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter4 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter4)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)

ggsave("images/Albumin_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Urinary albumin excretion")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Urinary albumin excretion",
         units == "unit increase")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype =="Urinary albumin excretion",
         units == "unit increase")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Urinary albumin excretion",
         units == "unit increase")
```

SNPs from Pilling (n=24) , Timmers (n= 28), Deleen 90th percentile (n=30	) and Deleen 99th percentile (n=30) are from one study.
Ass# GCST006586
PubmedID: 30220432

# Smoking 5

```{r}
betas <- sel_graph %>%
  filter(exposure == "Age of smoking initiation (MTAG) (unit decrease)" )%>%
  select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == "Age of smoking initiation (MTAG) (unit decrease)" )%>%
  select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == "Age of smoking initiation (MTAG) (unit decrease)" )%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c( "Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Age of smoking initiation (MTAG) (unit decrease)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data5 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data
ggplot(graph.data5) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Age of smoking initiation (MTAG) (unit decrease)" )

Timmers_harm_dat  <- Timmers %>%
  filter(exposure == "Age of smoking initiation (MTAG) (unit decrease)" )

Cases90_harm_dat  <- Cases90 %>%
  filter(exposure == "Age of smoking initiation (MTAG) (unit decrease)" )

Cases99_harm_dat  <- Cases99 %>%
  filter(exposure == "Age of smoking initiation (MTAG) (unit decrease)" )
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test5 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test5, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test5 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test5, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test5 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test5, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter5 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter5)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)

ggsave("images/smoking_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Age of smoking initiation (MTAG)",
         units == "unit decrease")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Age of smoking initiation (MTAG)",
         units == "unit decrease")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Age of smoking initiation (MTAG)",
         units == "unit decrease")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Age of smoking initiation (MTAG)",
         units == "unit decrease")
```

SNPs from Pilling (n=49),  Timmers (n= 49), Deleen 90th percentile (n=51) and Deleen 99th percentile (n=51) are from the same study.

Pubmed ID : 30643251
Study Ass # : GCST007462



# Systolic blood pressure (unit increase) 6
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Systolic blood pressure (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Systolic blood pressure (unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Systolic blood pressure (unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c( "Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Systolic blood pressure (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data6 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data6
ggplot(graph.data6) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```




## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Systolic blood pressure (unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Systolic blood pressure (unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Systolic blood pressure (unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Systolic blood pressure (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test6 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test6, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test6 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test6, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test6 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test6, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter6 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter6)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)

ggsave("images/SysBP_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Systolic blood pressure",
         units == "unit increase" )
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Systolic blood pressure",
         units == "unit increase" )
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Systolic blood pressure",
         units == "unit increase" )
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Systolic blood pressure",
         units == "unit increase" )
```

SNPs from Pilling (n=81). SNPs from Timmers (n= 85), Deleen 90th percentile (n=88) and Deleen 99th percentile (n=88) are from the same study.


-mixed population need to save as csv file for further review
```{r eval = FALSE}

## issues with population save all four as csv for reference and further examination

# write_csv(pilling_exp_data, "SystolicBP-SNP-population/pilling_exp_data.csv")
# write_csv(timmers_exp_data, "SystolicBP-SNP-population/timmers_exp_data.csv")
# write_csv(cases90_exp_data, "SystolicBP-SNP-population/cases90_exp_data.csv")
# write_csv(cases99_exp_data, "SystolicBP-SNP-population/cases99_exp_data.csv")
```



# Age at first sexual intercourse 7
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Age at first sexual intercourse"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Age at first sexual intercourse"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Age at first sexual intercourse"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c( "Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("	Age at first sexual intercourse")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data7 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data7
ggplot(graph.data7) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```




## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Age at first sexual intercourse")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Age at first sexual intercourse")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Age at first sexual intercourse")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Age at first sexual intercourse")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test7 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test7, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test7 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test7, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test7 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)

p1 <- mr_leaveoneout_plot(loo.pilling)
p2 <- mr_leaveoneout_plot(loo.timmers)
p3 <- mr_leaveoneout_plot(loo.cases90)
p4 <- mr_leaveoneout_plot(loo.cases99)

p1 <- grid.arrange(grobs = p1)
p2 <- grid.arrange(grobs = p2)
p3 <- grid.arrange(grobs = p3)
p4 <- grid.arrange(grobs = p4)
```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test7, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, all SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter7 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter7)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)

ggsave("images/sexualintercourse_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Age at first sexual intercourse")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Age at first sexual intercourse")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Age at first sexual intercourse")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Age at first sexual intercourse")
```

SNPs from Pilling (n=18). SNPs from Timmers (n= 17), Deleen 90th percentile (n=18) and Deleen 99th percentile (n=18) are from the same study.
Ass# GCST007335
PubmedID : 27089180

# Educational Attainment 8

```{r}
betas <- sel_graph %>%
  filter(exposure == c("Educational attainment (years of education) (unit decrease)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Educational attainment (years of education) (unit decrease)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Educational attainment (years of education) (unit decrease)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c("Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Educational attainment (years of education) (unit decrease)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data8 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se),
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data8
ggplot(graph.data8) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) +
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Educational attainment (years of education) (unit decrease)")

Timmers_harm_dat<- Timmers %>%
  filter(exposure == "Educational attainment (years of education) (unit decrease)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Educational attainment (years of education) (unit decrease)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Educational attainment (years of education) (unit decrease)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test8 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test8, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data.

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test8 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)

```

```{r}
kbl(pli_test8, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test8 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b,
         SE = se,
         `p-value` = p)

```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test8, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap.


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter8 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter8)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)

ggsave("images/EducationAttainment_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Educational attainment (years of education)")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Educational attainment (years of education)")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Educational attainment (years of education)")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Educational attainment (years of education)")
```

SNPs from Pilling (n=233). SNPs from Timmers (n= 256), Deleen 90th percentile (n=265) and Deleen 99th percentile (n=265) are from three studies.

Ass #GCST006442
PubmedID # 30038396

Ass #GCST007037
PubmedID # 30595370

Ass #GCST003676
PubmedID # 27225129

# Depressive Symptoms 9


```{r}
betas <- sel_graph %>%
  filter(exposure == c("Depressive symptoms (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Depressive symptoms (unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Depressive symptoms (unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()
Outcome <- c("Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Depressive symptoms (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se,nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data9 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data9
ggplot(graph.data9) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```




## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Depressive symptoms (unit increase)")

Timmers_harm_dat  <- Timmers %>%
  filter(exposure == "Depressive symptoms (unit increase)")

Cases90_harm_dat  <- Cases90 %>%
  filter(exposure == "Depressive symptoms (unit increase)")

Cases99_harm_dat  <- Cases99 %>%
  filter(exposure == "Depressive symptoms (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat )%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat )%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat )%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat )%>%
  mutate(Outcome.dat = "Cases99")

het_test9 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test9, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat )%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat )%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat )%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat )%>%
  mutate(Outcome.dat = "Cases99")

pli_test9 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test9, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test9 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test9, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter9 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter9)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/Depression_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Depressive symptoms")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Depressive symptoms")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Depressive symptoms")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Depressive symptoms")
```

SNPs from Pilling (n=59) , Timmers (n= 70), Deleen 90th percentile (n=73) and Deleen 99th percentile (n=73) are from the two studies.


Ass # GCST007340
Pubmed# 30643256


Ass # GCST005324
Pubmed# 29292387


# Highest Math class 10

```{r}
betas <- sel_graph %>%
  filter(exposure == c("Highest math class taken (MTAG) (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Highest math class taken (MTAG) (unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Highest math class taken (MTAG) (unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c("Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Highest math class taken (MTAG) (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data10 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data10
ggplot(graph.data10) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Highest math class taken (MTAG) (unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Highest math class taken (MTAG) (unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Highest math class taken (MTAG) (unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Highest math class taken (MTAG) (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test10 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test10, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test10 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test10, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test10 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)



```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test10, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter10 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter10)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/Math_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Highest math class taken (MTAG)")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Highest math class taken (MTAG)")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Highest math class taken (MTAG)")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Highest math class taken (MTAG)")
```

SNPs from Pilling (n=218). SNPs from Timmers (n= 233), Deleen 90th percentile (n=237) and Deleen 99th percentile (n=238) are from the same study.# Depressive Symptoms

Ass# GCST006568
PubmedID # 30038396	

# Well-being spectrum 11
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Well-being spectrum (multivariate analysis) (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Well-being spectrum (multivariate analysis) (unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Well-being spectrum (multivariate analysis) (unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()
Outcome <- c("Pilling", "Timmers",  "Deleen 90", "Deleen 99")
exposure <- c("Well-being spectrum (multivariate analysis) (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data11 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data11
ggplot(graph.data11) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```




## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Well-being spectrum (multivariate analysis) (unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Well-being spectrum (multivariate analysis) (unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Well-being spectrum (multivariate analysis) (unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Well-being spectrum (multivariate analysis) (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test11 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test11, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test11 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test11, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test11 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test11, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter11 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter11)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/wellbeing_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Well-being spectrum (multivariate analysis)")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Well-being spectrum (multivariate analysis)")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Well-being spectrum (multivariate analysis)")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Well-being spectrum (multivariate analysis)")
```

SNPs from Pilling (n=67). SNPs from Timmers (n= 75), Deleen 90th percentile (n=78) and Deleen 99th percentile (n=77) are from the same study.

Ass# GCST007341
Pubmed ID 30643256

# Coronary artery disease 12
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Coronary artery disease (unit decrease)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Coronary artery disease (unit decrease)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Coronary artery disease (unit decrease)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()
Outcome <- c("Pilling", "Timmers", "Deleen 90", "Deleen 99")
exposure <- c("Coronary artery disease (unit decrease)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data12 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data12
ggplot(graph.data12) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```




## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Coronary artery disease (unit decrease)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Coronary artery disease (unit decrease)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Coronary artery disease (unit decrease)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Coronary artery disease (unit decrease)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test12 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test12, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test12 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test12, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test12 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test12, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter12 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter12)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/coronary_disease_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Coronary artery disease",
         units == "unit decrease")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Coronary artery disease",
         units == "unit decrease")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Coronary artery disease",
         units =="unit decrease")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Coronary artery disease",
         units == "unit decrease")
```

SNPs from Pilling (n=115),  Timmers (n= 127), Deleen 90th percentile (n=128) and Deleen 99th percentile (n=127) are from one study.


Ass # GCST005194, GCST005195, GCST005196
PubmedID # 29212778


# Medication use (agents acting on the renin-angiotensin system) (unit increase) 13
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Medication use (agents acting on the renin-angiotensin system) (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Medication use (agents acting on the renin-angiotensin system) (unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Medication use (agents acting on the renin-angiotensin system) (unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c("Pilling","Timmers",  "Deleen 90", "Deleen 99")
exposure <- c("Medication use (agents acting on the renin-angiotensin system) (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data13 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data13
ggplot(graph.data13) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Medication use (agents acting on the renin-angiotensin system) (unit increase)")

Timmers_harm_dat  <- Timmers %>%
  filter(exposure == "Medication use (agents acting on the renin-angiotensin system) (unit increase)")

Cases90_harm_dat  <- Cases90 %>%
  filter(exposure == "Medication use (agents acting on the renin-angiotensin system) (unit increase)")

Cases99_harm_dat  <- Cases99 %>%
  filter(exposure == "Medication use (agents acting on the renin-angiotensin system) (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat )%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat )%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat )%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat )%>%
  mutate(Outcome.dat = "Cases99")

het_test13 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test13, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers and Deleen data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat )%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat )%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat )%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat )%>%
  mutate(Outcome.dat = "Cases99")

pli_test13 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test13, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat )%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat )%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat )%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat )%>%
  mutate(outcome.data = "Cases99")

loo_test13 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)

p1 <- mr_leaveoneout_plot(loo.pilling)
p2 <- mr_leaveoneout_plot(loo.timmers)
p3 <- mr_leaveoneout_plot(loo.cases90)
p4 <- mr_leaveoneout_plot(loo.cases99)

p1 <- grid.arrange(grobs = p1)
p2 <- grid.arrange(grobs = p2)
p3 <- grid.arrange(grobs = p3)
p4 <- grid.arrange(grobs = p4)
```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test13, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat , method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat , method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat , method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat , method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter13 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter13)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/cardio_drug_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat , all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Medication use (agents acting on the renin-angiotensin system)")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Medication use (agents acting on the renin-angiotensin system)")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Medication use (agents acting on the renin-angiotensin system)")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Medication use (agents acting on the renin-angiotensin system)")
```

SNPs from Pilling (n=63), Timmers (n= 67), Deleen 90th percentile (n=68) and Deleen 99th percentile (n=68) are from the same study.

Ass# GCST007931	
PubMed ID 31015401

# Parental Longevity 14
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Parental longevity (both parents in top 10%) (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Parental longevity (both parents in top 10%) (unit increase)" ))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Parental longevity (both parents in top 10%) (unit increase)" ))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c("Pilling", "Timmers",  "Deleen 90", "Deleen 99")
exposure <- c("Parental longevity (both parents in top 10%) (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data14 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se), 
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data14
ggplot(graph.data14) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) + 
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Parental longevity (both parents in top 10%) (unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Parental longevity (both parents in top 10%) (unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Parental longevity (both parents in top 10%) (unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Parental longevity (both parents in top 10%) (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test14 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test14, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Evidence of Heterogeneity in the Timmers data. 

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test14 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)
  
```

```{r}
kbl(pli_test14, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test14 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b, 
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test14, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap. 


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter14 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter14)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/parental_longevity_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Parental longevity (both parents in top 10%)")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Parental longevity (both parents in top 10%)")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Parental longevity (both parents in top 10%)")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Parental longevity (both parents in top 10%)")
```

SNPs from Pilling (n=4). SNPs from Timmers (n= 4), Deleen 90th percentile (n=4) and Deleen 99th percentile (n=4) are from the same study. Pilling with itself (not 2MR)

Ass # GCST006697
PubMed ID # 29227965

# Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase) 15
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c("Pilling", "Timmers",  "Deleen 90", "Deleen 99")
exposure <- c("Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se,nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data15 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se),
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data15
ggplot(graph.data15) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) +
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/pilling_df_gwas_ieu.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/timmers_gwas_ieu_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_ieu_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_ieu_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Antipsychotic drug-induced QTc interval change in schizophrenia (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test15 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test15, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

No evidence of heterogeneity

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test15 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)

```

```{r}
kbl(pli_test15, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test15 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b,
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test15, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap.


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter15 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter15)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/schizophrenia_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Antipsychotic drug-induced QTc interval change in schizophrenia")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Antipsychotic drug-induced QTc interval change in schizophrenia")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Antipsychotic drug-induced QTc interval change in schizophrenia")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Antipsychotic drug-induced QTc interval change in schizophrenia")
```

SNPs from Pilling (n=2), Timmers (n= 2), Deleen 90th percentile (n=2) and Deleen 99th percentile (n=2) are from the same study.


Ass # GCST004987
PubmedID # 29064910

# Breast  cancer 16
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Breast cancer (unit increase)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Breast cancer (unit increase)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Breast cancer (unit increase)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()
Outcome <- c("Pilling", "Timmers",  "Deleen 90", "Deleen 99")
exposure <- c("Breast cancer (unit increase)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se,nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data16 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se),
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data16
ggplot(graph.data16) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) +
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Breast cancer (unit increase)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Breast cancer (unit increase)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Breast cancer (unit increase)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Breast cancer (unit increase)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test16 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test16, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

No evidence of heterogeneity

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test16 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)

```

```{r}
kbl(pli_test16, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test16 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b,
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test16, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap.


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter16 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter16)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/breastcancer_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Breast cancer")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Breast cancer")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Breast cancer")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Breast cancer")
```

SNPs from Pilling (n=86), Timmers (n= 98), Deleen 90th percentile (n=100) and Deleen 99th percentile (n=100) are from four studies.


Ass # GCST004988	
PubmedID # 29059683

Ass # GCST005077
PubmedID # 29058716
Ass # GCST003845
PubmedID # 27117709
Ass # GCST007236
PubmedID # 25751625

# Total hippocampal volume 17
```{r}
betas <- sel_graph %>%
  filter(exposure == c("Total hippocampal volume (NR mm3 decrease)"))%>%
  dplyr::select( b.pilling, b.timmers, b.90, b.99) %>%
  unlist()
se <- sel_graph %>%
  filter(exposure == c("Total hippocampal volume (NR mm3 decrease)"))%>%
  dplyr::select(se.pilling, se.timmers, se.90, se.99)%>%
  unlist()
nsnp <- sel_graph %>%
  filter(exposure == c("Total hippocampal volume (NR mm3 decrease)"))%>%
  dplyr::select(nsnp.pilling, nsnp.timmers, nsnp.90, nsnp.99)%>%
  unlist()

Outcome <- c("Pilling", "Timmers",  "Deleen 90", "Deleen 99")
exposure <- c("Total hippocampal volume (NR mm3 decrease)")
graph.data <- as.data.frame(cbind(Outcome,exposure, betas, se, nsnp))

graph.data$betas <- as.numeric(graph.data$betas)
graph.data$se <- as.numeric(graph.data$se)

graph.data17 <- graph.data %>%
  mutate(lower.CI = betas - (1.96*se),
         upper.CI = betas + (1.96*se),
         OR = exp(betas),
         lower.OR.CI = exp(lower.CI),
         upper.OR.CI = exp(upper.CI))
graph.data17
ggplot(graph.data17) +
  geom_segment(aes(x = lower.CI, xend = upper.CI, y= 1:4, yend = 1:4, col = Outcome)) +
  xlab("") +
  ylab("") +
  ggtitle("Confidence Intervals for Four Longevity Outcomes")
```


As expected, the most overlap is between the two Deleen definitions and the Pilling and Timmers datasets (UK Biobank).

## Sensivity Analysis

```{r include=FALSE}
Pilling <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Pilling/pilling_download_gwas.rds")
Timmers <- timmers_gwas_df <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Timmers/timmers_gwas_df.rds")
Cases90 <-  readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases90/cases_90_gwas_df.rds")
Cases99 <- readRDS("C:/Users/me/Desktop/MPH/Internship/CPMC/Longevity/data/harmonized/Cases99/cases_99_gwas_df.rds")

#filter by Alzheimer

Pilling_harm_dat <- Pilling %>%
  filter(exposure == "Total hippocampal volume (NR mm3 decrease)")

Timmers_harm_dat <- Timmers %>%
  filter(exposure == "Total hippocampal volume (NR mm3 decrease)")

Cases90_harm_dat <- Cases90 %>%
  filter(exposure == "Total hippocampal volume (NR mm3 decrease)")

Cases99_harm_dat <- Cases99 %>%
  filter(exposure == "Total hippocampal volume (NR mm3 decrease)")
```

### Heterogeneity Test

```{r include=FALSE}
het.pilling <- mr_heterogeneity(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
het.timmers <- mr_heterogeneity(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
het.cases90 <- mr_heterogeneity(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
het.cases99 <- mr_heterogeneity(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

het_test17 <- rbind(het.pilling,het.timmers,het.cases90,het.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, method, Q, Q_df, Q_pval) %>%
  rename(`Longevity Definition` = Outcome.dat)
```

```{r}
kbl(het_test17, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

No evidence of heterogeneity

### Check for Pleiotropy

```{r include=FALSE}
plei.pilling <- mr_pleiotropy_test(Pilling_harm_dat)%>%
  mutate(Outcome.dat = "Pilling")
plei.timmers <- mr_pleiotropy_test(Timmers_harm_dat)%>%
  mutate(Outcome.dat = "Timmers")
plei.cases90 <- mr_pleiotropy_test(Cases90_harm_dat)%>%
  mutate(Outcome.dat = "Cases90")
plei.cases99 <- mr_pleiotropy_test(Cases99_harm_dat)%>%
  mutate(Outcome.dat = "Cases99")

pli_test17 <- rbind(plei.pilling, plei.timmers,plei.cases90,plei.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(Outcome.dat, exposure, egger_intercept, se, pval) %>%
  rename(`Longevity Definition` = Outcome.dat,
         `Egger Intercept` = egger_intercept)

```

```{r}
kbl(pli_test17, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

no indication from this test that there is the presence of horizontal pleiotropy


## Leave on out Analysis - Check to see if there is one SNP influencing the results
```{r include=FALSE}
loo.pilling <- mr_leaveoneout(Pilling_harm_dat)%>%
  mutate(outcome.data = "Pilling")
loo.timmers <-mr_leaveoneout(Timmers_harm_dat)%>%
  mutate(outcome.data = "Timmers")
loo.cases90 <-mr_leaveoneout(Cases90_harm_dat)%>%
  mutate(outcome.data = "Cases90")
loo.cases99 <- mr_leaveoneout(Cases99_harm_dat)%>%
  mutate(outcome.data = "Cases99")

loo_test17 <- rbind(loo.pilling, loo.timmers,loo.cases90,loo.cases99) %>%
  select(-id.exposure, -id.outcome, -outcome) %>%
  select(outcome.data, exposure, samplesize, SNP, b,se, p) %>%
  rename(`Longevity Definition` = outcome.data,
         `Sample Size` = samplesize,
         Beta = b,
         SE = se,
         `p-value` = p)


```


```{r}
plot_grid(p1, p2, labels = c("Pilling", "Timmers"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -1, label_colour = "blue")

plot_grid(p3, p4, labels = c("Deleen 90", "Deleen 99"),label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")

kbl(loo_test15, booktabs = T, caption = "Leave one out Analysis ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```

Although there are some SNPs which significantly affect the point estimate, most SNPs overlap.


## Scatter plot of Three Methods
```{r cache= TRUE, include=FALSE}
mr.pilling <- mr(Pilling_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.timmers <- mr(Timmers_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases90 <- mr(Cases90_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))
mr.cases99 <- mr(Cases99_harm_dat, method_list = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))

sc.pilling <- mrscatter_nolegend(mr.pilling, Pilling_harm_dat, title = "(a) Pilling")
sc.timmers <- mrscatter_nolegend(mr.timmers, Timmers_harm_dat, title ="(b) Timmers")
sc.cases90 <- mrscatter_nolegend(mr.cases90, Cases90_harm_dat, title ="(c) Deleen 90th Percentile")
sc.cases99 <- mrscatter_legend(mr.cases99, Cases99_harm_dat, title ="(d) Deleen 99th Percentile")

```

```{r}
exposure <- Pilling_harm_dat$exposure[1]

scatter <- plot_grid(sc.pilling[[1]],sc.timmers[[1]], sc.cases90[[1]], sc.cases99[[1]], nrow = 2)

scatter17 <- add_sub(scatter, paste("SNP effect on ", exposure), y = 0.2, vjust = 0, size = 8 )
ggdraw(scatter17)

# to check if the graph is the same
#mr_scatter_plot(mr.timmers, Timmers_harm_dat)


ggsave("images/hippocampus_scatter.png")
```

## Forest Plot of Single SNP estimates compared to estimates with all SNPs

```{r include=FALSE}
pilling.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.forest <- grid.arrange(grobs = mr_forest_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.forest, timmers.forest,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.forest, cases99.forest,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## Funnel plot of Single SNP analysis compared to the estimates from all SNPs



```{r include=FALSE}
pilling.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
timmers.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases90.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
cases99.funnel <- grid.arrange(grobs = mr_funnel_plot(mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))))
```

```{r}
plot_grid(pilling.funnel, timmers.funnel,labels =  c("Pilling", "Timmers"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
plot_grid(cases90.funnel, cases99.funnel,labels =  c("Deleen 90", "Deleen 99"), label_x = 0, label_y = 0.05,
  hjust = 0, vjust = -0.5, label_colour = "blue")
```

## look for source of exposures

Are the SNP-Exposure associations from the same study?
```{r}
pilling.ssnp <- mr_singlesnp(Pilling_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
timmers.ssnp <- mr_singlesnp(Timmers_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median"))%>% pull(SNP)
cases90.ssnp <- mr_singlesnp(Cases90_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)
cases99.ssnp <- mr_singlesnp(Cases99_harm_dat, all_method = c("mr_egger_regression", "mr_ivw", "mr_weighted_median")) %>% pull(SNP)


data("gwas_catalog")


#dataframe of source data

pilling_exp_data <- gwas_catalog %>%
  filter(SNP %in% pilling.ssnp,
         Phenotype == "Total hippocampal volume")
timmers_exp_data <- gwas_catalog %>%
  filter(SNP %in% timmers.ssnp,
         Phenotype == "Total hippocampal volume")
cases90_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases90.ssnp,
         Phenotype == "Total hippocampal volume")
cases99_exp_data <- gwas_catalog %>%
  filter(SNP %in% cases99.ssnp,
         Phenotype == "Total hippocampal volume")
```

SNPs from Pilling (n=3), Timmers (n= 3), Deleen 90th percentile (n=3) and Deleen 99th percentile (n=3) are from the same study.


Ass # GCST006871
PubmedID # 30279459

# summary of selected Exposures

## Selected Exposures

```{r}
options(scipen = 999)
sel_exp <- rbind(graph.data1,graph.data2,graph.data3,graph.data4,graph.data5,graph.data6,graph.data7,graph.data8,graph.data9,graph.data10,graph.data11,graph.data12,graph.data13,graph.data14,graph.data15,graph.data16, graph.data17) 

# round numeric columns 
sel_exp$OR <- signif(sel_exp$OR, digits = 4)
sel_exp$lower.OR.CI <- signif(sel_exp$lower.OR.CI, digits = 4)
sel_exp$upper.OR.CI <- signif(sel_exp$upper.OR.CI, digits = 4)

#create table 2
sel_exp <- sel_exp %>%
  mutate(CI.95 = paste("(", lower.OR.CI, ", ", upper.OR.CI, ")"))%>%
  select(Outcome, exposure, OR, CI.95, nsnp)
  

kbl(sel_exp, booktabs = T, caption = "Table 2. Selected Exposures for Further Analysis")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```


## Heterogeneity

```{r}
het_test <- rbind(het_test1,het_test2, het_test3, het_test4, het_test5, het_test6, het_test7,het_test8, het_test9, het_test10, het_test11, het_test12, het_test13, het_test14, het_test15,het_test16, het_test17 )

kbl(het_test, booktabs = T, caption = "Test for Heterogeneity using Cochran's Q-test")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```


## Pleiotropy

```{r}
pli_test <- rbind(pli_test1, pli_test2, pli_test3, pli_test4, pli_test5, pli_test6, pli_test7,pli_test8,  pli_test9, pli_test10, pli_test11, pli_test12, pli_test13, pli_test14, pli_test15,pli_test16, pli_test17)
kbl(pli_test, booktabs = T, caption = "Test for Pleiotropy ")%>%
  kable_classic()%>%
  kable_styling(bootstrap_options = "striped")
```


#leveoneout
# ```{r}
# loo_test <- rbind(loo_test1, loo_test2, loo_test3, loo_test4, loo_test5, loo_test6, loo_test7,  loo_test9, loo_test10, loo_test11, loo_test12, loo_test13, loo_test14)
# kbl(loo_test, booktabs = T, caption = "Leave one out Analysis ")%>%
#   kable_classic()%>%
#   kable_styling(bootstrap_options = "striped")
# ```

# Cleaned up LOO graphs


```{r }

#Alzheimers
loo_graphs(loo_test1, exposure = "Alzheimer's disease or family history of Alzheimer's disease", outcome = "Longevity" )
ggsave( "images/Alzheimer_loo.png")

#Thyroid
loo_graphs(loo_test2, exposure = "Thyroid peroxidase antibody levels", outcome = "Longevity" )
ggsave( "images/Thyroid_loo.png")

#RA
loo_graphs(loo_test3, exposure = "Rheumatoid arthritis", outcome = "Longevity" )
ggsave( "images/RA_loo.png")

#Urinary albumin excretion
loo_graphs(loo_test4, exposure = "Urinary albumin excretion", outcome = "Longevity" )
ggsave( "images/Albumin_loo.png")

#cigarettes
loo_graphs(loo_test5, exposure ="Age of smoking initiation (MTAG)", outcome = "Longevity" )
ggsave( "images/cigarettes_loo.png")

#obesity
loo_graphs(loo_test6, exposure = "Systolic blood pressure", outcome = "Longevity" )
ggsave( "images/Obesity_loo.png")

#Age at first sexual intercourse
loo_graphs(loo_test7, exposure = "Age at first sexual intercourse", outcome = "Longevity" )
ggsave( "images/sexualintercourse_loo.png")

#Autism and other disorders
loo_graphs(loo_test8, exposure = "Educational attainment (years of education)", outcome = "Longevity" )
ggsave( "images/EducationalAttainment_loo.png")

#Depressive symptoms
loo_graphs(loo_test9, exposure = "Depressive symptoms", outcome = "Longevity" )
ggsave( "images/Depression_loo.png")

#Cognitive scores : highest math class taken
loo_graphs(loo_test10, exposure = "Highest math class taken (MTAG)", outcome = "Longevity" )
ggsave( "images/Math_loo.png")


#Well being spectrum
loo_graphs(loo_test11, exposure = "Well-being spectrum", outcome = "Longevity" )
ggsave( "images/wellbeing_loo.png")


#coronary disease
loo_graphs(loo_test12, exposure = "Coronary artery disease", outcome = "Longevity" )
ggsave( "images/coronary_disease_loo.png")

#cardiovascular drug use
loo_graphs(loo_test13, exposure = "Medication use (agents acting on the renin-angiotensin system)", outcome = "Longevity" )
ggsave( "images/cardio_drug_loo.png")

#parental longevity
loo_graphs(loo_test14, exposure = "Parental longevity (both parents in top 10%)", outcome = "Longevity" )
ggsave( "images/Parental_longevity_loo.png")

#Antipsychotic drug-induced QTc interval change in schizophrenia
loo_graphs(loo_test15, exposure = "Antipsychotic drug-induced QTc interval change in schizophrenia", outcome = "Longevity" )
ggsave( "images/schizophrenia_loo.png")

#Breast  cancer
loo_graphs(loo_test16, exposure = "Breast  cancer", outcome = "Longevity" )
ggsave( "images/BreastCancer_loo.png")

#Total hippocampal volume
loo_graphs(loo_test17, exposure = "Total hippocampal volume", outcome = "Longevity" )
ggsave( "images/Hippocampus_loo.png")


```






